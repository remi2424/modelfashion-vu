!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b():"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?exports.Leanplum=b():a.Leanplum=b()}(this,function(){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.i=function(a){return a},b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a.default}:function(){return a};return b.d(c,"a",c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p="",b(b.s=7)}([function(a,b,c){var d,e,f;!function(c,g){e=[a],d=g,void 0!==(f="function"==typeof d?d.apply(b,e):d)&&(a.exports=f)}(0,function(a){"use strict";a.exports={METHODS:{START:"start",STOP:"stop",ADVANCE:"advance",TRACK:"track",PAUSE_SESSION:"pauseSession",RESUME_SESSION:"resumeSession",PAUSE_STATE:"pauseState",RESUME_STATE:"resumeState",DOWNLOAD_FILE:"downloadFile",MULTI:"multi",SET_VARS:"setVars",GET_VARS:"getVars",SET_USER_ATTRIBUTES:"setUserAttributes",SET_DEVICE_ATTRIBUTES:"setDeviceAttributes",UPLOAD_FILE:"uploadFile",REGISTER_DEVICE:"registerDevice"},SDK_VERSION:"1.2.4",CLIENT:"js",PARAMS:{ACTION:"action",APP_ID:"appId",CLIENT:"client",CLIENT_KEY:"clientKey",DEVICE_ID:"deviceId",SDK_VERSION:"sdkVersion",USER_ID:"userId",NEW_USER_ID:"newUserId",DEV_MODE:"devMode",VERSION_NAME:"versionName",SYSTEM_NAME:"systemName",SYSTEM_VERSION:"systemVersion",BROWSER_NAME:"browserName",BROWSER_VERSION:"browserVersion",DEVICE_NAME:"deviceName",DEVICE_MODEL:"deviceModel",USER_ATTRIBUTES:"userAttributes",LOCALE:"locale",COUNTRY:"country",REGION:"region",CITY:"city",LOCATION:"location",STATE:"state",INFO:"info",EVENT:"event",VALUE:"value",FILENAME:"filename",TIME:"time",DATA:"data",VARS:"vars",FILE:"file",SIZE:"size",VARIATION:"variation",HASH:"hash",EMAIL:"email",VARIABLES:"vars",PARAMS:"params",INCLUDE_DEFAULTS:"includeDefaults",WEB_PUSH_SUBSCRIPTION:"webPushSubscription"},KEYS:{IS_REGISTERED:"isRegistered",LATEST_VERSION:"latestVersion",VARS:"vars",VARIANTS:"variants",ACTION_METADATA:"actionMetadata",TOKEN:"token"},DEFAULT_KEYS:{COUNT:"__leanplum_unsynced",ITEM:"__leanplum_unsynced_",VARIABLES:"__leanplum_variables",VARIANTS:"__leanplum_variants",ACTION_METADATA:"__leanplum_action_metadata",TOKEN:"__leanplum_token",DEVICE_ID:"__leanplum_device_id",USER_ID:"__leanplum_user_id",PUSH_SUBSCRIPTION:"__leanplum_push_subscription"},VALUES:{DETECT:"(detect)"}}})},function(a,b,c){var d,e,f;!function(c,g){e=[a],d=g,void 0!==(f="function"==typeof d?d.apply(b,e):d)&&(a.exports=f)}(0,function(a){"use strict";function b(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var c=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),d=[],e=10,f=function(){function a(){b(this,a)}return c(a,null,[{key:"setNetworkTimeout",value:function(a){e=a}},{key:"ajax",value:function(b,c,d,f,g,h,i){if(h){if(a._runningRequest)return a._enqueueRequest(arguments);a._runningRequest=!0}if("undefined"!=typeof XDomainRequest)return"http:"===location.protocol&&0==c.indexOf("https:")&&(c="http:"+c.substring(6)),a._ajaxIE8.apply(null,arguments);var j=!1,k=new XMLHttpRequest;k.onreadystatechange=function(){if(4===k.readyState){if(j)return;j=!0;var b=void 0,c=!1;if(i)b=k.responseText;else try{b=JSON.parse(k.responseText)}catch(a){setTimeout(function(){g&&g(null,k)},0),c=!0}c||(k.status>=200&&k.status<300?setTimeout(function(){f&&f(b,k)},0):setTimeout(function(){g&&g(b,k)},0)),h&&(a._runningRequest=!1,a._dequeueRequest())}},k.open(b,c,!0),k.setRequestHeader("Content-Type","text/plain"),k.send(d),setTimeout(function(){j||k.abort()},1e3*e)}},{key:"_ajaxIE8",value:function(b,c,d,f,g,h,i){var j=new XDomainRequest;j.onload=function(){var b=void 0,c=!1;if(i)b=j.responseText;else try{b=JSON.parse(j.responseText)}catch(a){setTimeout(function(){g&&g(null,j)},0),c=!0}c||setTimeout(function(){f&&f(b,j)},0),h&&(a._runningRequest=!1,a._dequeueRequest())},j.onerror=j.ontimeout=function(){setTimeout(function(){g&&g(null,j)},0),h&&(a._runningRequest=!1,a._dequeueRequest())},j.onprogress=function(){},j.open(b,c),j.timeout=1e3*e,j.send(d)}},{key:"_enqueueRequest",value:function(a){d.push(a)}},{key:"_dequeueRequest",value:function(){var b=d.shift();b&&a.ajax.apply(null,b)}}]),a}();a.exports=f})},function(a,b,c){var d,e,f;!function(c,g){e=[a,b],d=g,void 0!==(f="function"==typeof d?d.apply(b,e):d)&&(a.exports=f)}(0,function(a,b){"use strict";function c(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function d(a,b,c,e){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof g&&(a=a._wrapped),b instanceof g&&(b=b._wrapped);var h=Object.prototype.toString.call(a);if(h!=Object.prototype.toString.call(b))return!1;switch(h){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=(void 0===a?"undefined":f(a))||"object"!=(void 0===b?"undefined":f(b)))return!1;for(var i=c.length;i--;)if(c[i]==a)return e[i]==b;c.push(a),e.push(b);var j=0,k=!0;if("[object Array]"==h){if(j=a.length,k=j==b.length)for(;j--&&(k=d(a[j],b[j],c,e)););}else{var l=a.constructor,m=b.constructor;if(l!==m&&!(g.isFunction(l)&&l instanceof l&&g.isFunction(m)&&m instanceof m))return!1;for(var n in a)if(g.has(a,n)&&(j++,!(k=g.has(b,n)&&d(a[n],b[n],c,e))))break;if(k){for(key in b)if(g.has(b,key)&&!j--)break;k=!j}}return c.pop(),e.pop(),k}Object.defineProperty(b,"__esModule",{value:!0});var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},g=function(){function a(){c(this,a)}return e(a,null,[{key:"iextend",value:function(a){return each(slice.call(arguments,1),function(b){for(var c in b)({}).hasOwnProperty.call(b,c)&&(a[c]=b[c])}),a}},{key:"isFunction",value:function(a){return"function"==typeof a}},{key:"has",value:function(a,b){return hasOwnProperty.call(a,b)}},{key:"isEqual",value:function(a,b){return d(a,b,[],[])}}]),a}();b.default=g,a.exports=b.default})},function(a,b,c){var d,e,f;!function(g,h){e=[a,c(0)],d=h,void 0!==(f="function"==typeof d?d.apply(b,e):d)&&(a.exports=f)}(0,function(a,b){"use strict";function c(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var d=function(a){return a&&a.__esModule?a:{default:a}}(b),e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=function(){function a(){c(this,a),this.argString="",this.argValues={}}return e(a,[{key:"add",value:function(a,b){return void 0===b?this:(this.argString&&(this.argString+="&"),this.argString+=a+"="+encodeURIComponent(b),this.argValues[a]=b,this)}},{key:"body",value:function(a){return a?(this._body=a,this):this._body}},{key:"attachApiKeys",value:function(a,b){return this.add(d.default.PARAMS.APP_ID,a).add(d.default.PARAMS.CLIENT,d.default.CLIENT).add(d.default.PARAMS.CLIENT_KEY,b)}},{key:"build",value:function(){return this.argString}},{key:"buildDict",value:function(){return this.argValues}}]),a}();a.exports=f})},function(a,b,c){var d,e,f;!function(c,g){e=[a],d=g,void 0!==(f="function"==typeof d?d.apply(b,e):d)&&(a.exports=f)}(0,function(a){"use strict";function b(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var c=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),d=[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],e=[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac OS"},{string:navigator.userAgent,subString:"iPhone",identity:"iOS"},{string:navigator.platform,subString:"Linux",identity:"Linux"}],f=function(){function a(){b(this,a),this.browser=this.searchString(d)||"An unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.OS=this.searchString(e)||"an unknown OS"}return c(a,[{key:"searchString",value:function(a){for(var b=0;b<a.length;b++){var c=a[b].string,d=a[b].prop;if(this.versionSearchString=a[b].versionSearch||a[b].identity,c){if(-1!=c.indexOf(a[b].subString))return a[b].identity}else if(d)return a[b].identity}}},{key:"searchVersion",value:function(a){if(a){var b=a.indexOf(this.versionSearchString);if(-1!=b)return parseFloat(a.substring(b+this.versionSearchString.length+1))}}}]),a}();a.exports=f})},function(a,b,c){var d,e,f;!function(g,h){e=[a,b,c(2),c(0)],d=h,void 0!==(f="function"==typeof d?d.apply(b,e):d)&&(a.exports=f)}(0,function(a,b,c,d){"use strict";function e(a){return a&&a.__esModule?a:{default:a}}function f(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(b,"__esModule",{value:!0});var g=e(c),h=e(d),i=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),j=void 0,k=void 0,l=!1,m=!1,n=null,o=function(){function a(b){f(this,a),k=b,j=this,navigator&&navigator.serviceWorker&&"serviceWorker"in navigator&&"PushManager"in window&&(l=!0)}return i(a,[{key:"isWebPushSupported",value:function(){return l}},{key:"isWebPushSubscribed",value:function(){return l?this._getServiceWorkerRegistration().then(function(a){return new Promise(function(b){a?a.pushManager.getSubscription().then(function(a){m=null!==a,m&&j._updateNewSubscriptionOnServer(a),b(m)}):b(!1)})}):new Promise(function(a,b){b("Leanplum: Push messaging is not supported.")})}},{key:"register",value:function(a,b){l||(console.log("Leanplum: Push messaging is not supported."),b(!1)),navigator.serviceWorker.register(a||"/sw.min.js").then(function(a){n=a,n.pushManager.getSubscription().then(function(a){m=!(null===a),m&&j._updateNewSubscriptionOnServer(a),b&&b(m)})}).catch(function(a){console.log("Leanplum: Service Worker Error: ",a)})}},{key:"subscribeUser",value:function(){var a=this._urlB64ToUint8Array("BInWPpWntfR39rgXSP04pqdmEdDGa50z6zqbMvxyxJCwzXIuSpSh8C888-CfJ82WELl7Xe8cjAnfCt-3vK0Ci68");return new Promise(function(b,c){return n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:a}).then(function(a){return a?(j._updateNewSubscriptionOnServer(a),m=!0,b(m)):(m=!1,c())}).catch(function(a){return c("Leanplum: Failed to subscribe the user: "+a)})})}},{key:"unsubscribeUser",value:function(){return new Promise(function(a,b){n.pushManager.getSubscription().then(function(a){return a?a.unsubscribe():b()}).catch(function(a){b("Leanplum: Error unsubscribing: "+a)}).then(function(c){return c?(m=!1,a()):b()})})}},{key:"_getServiceWorkerRegistration",value:function(){return new Promise(function(a){n?a(n):navigator.serviceWorker.getRegistration().then(function(b){a(b)})})}},{key:"_urlB64ToUint8Array",value:function(a){for(var b="=".repeat((4-a.length%4)%4),c=(a+b).replace(/\-/g,"+").replace(/_/g,"/"),d=window.atob(c),e=new Uint8Array(d.length),f=0;f<d.length;++f)e[f]=d.charCodeAt(f);return e}},{key:"_prepareSubscription",value:function(a){var b=a.getKey?a.getKey("p256dh"):"",c=a.getKey?a.getKey("auth"):"",d=btoa(String.fromCharCode.apply(null,new Uint8Array(b))),e=btoa(String.fromCharCode.apply(null,new Uint8Array(c)));return{endpoint:a.endpoint,key:d,auth:e}}},{key:"_updateNewSubscriptionOnServer",value:function(a){if(a){var b=this._prepareSubscription(a),c=JSON.stringify(b),d=k._getFromLocalStorage(h.default.DEFAULT_KEYS.PUSH_SUBSCRIPTION);g.default.isEqual(d,c)||(k._saveToLocalStorage(h.default.DEFAULT_KEYS.PUSH_SUBSCRIPTION,c),k._setSubscription(c))}}}]),a}();b.default=o,a.exports=b.default})},function(a,b,c){var d,e,f;!function(g,h){e=[a,c(1)],d=h,void 0!==(f="function"==typeof d?d.apply(b,e):d)&&(a.exports=f)}(0,function(a,b){"use strict";function c(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var d=function(a){return a&&a.__esModule?a:{default:a}}(b),e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=function(){function a(){c(this,a),this.connected=!1,this.connecting=!1}return e(a,[{key:"connect",value:function(a){var b=this;b.connecting=!0,d.default.ajax("POST","https://"+a+"/socket.io/1","",function(c){var d=c.split(":"),e=d[0],f=parseInt(d[1])/2*1e3;b.socket=new WebSocket("wss://"+a+"/socket.io/1/websocket/"+e);var g=null;b.socket.onopen=function(){b.connected=!0,b.connecting=!1,b.onopen&&b.onopen(),g=setInterval(function(){b.socket.send("2:::")},f)},b.socket.onclose=function(){b.connected=!1,clearInterval(g),b.onclose&&b.onclose()},b.socket.onmessage=function(a){var c=a.data.split(":"),d=parseInt(c[0]);if(2==d)b.socket.send("2::");else if(5==d){var e=c[1],f=JSON.parse(c.slice(3).join(":")),g=f.name,h=f.args;e&&b.socket.send("6:::"+e),b.onmessage&&b.onmessage(g,h)}else 7==d&&console.log("Socket error: "+a.data)},b.socket.onerror=function(a){b.socket.close(),b.onerror&&b.onerror(a)}},null,!1,!0)}},{key:"send",value:function(a,b){if(!this.connected)return void console.log("Leanplum: Socket is not connected.");this.socket.send("5:::"+JSON.stringify({name:a,args:b}))}}]),a}();a.exports=f})},function(a,b,c){var d,e,f;!function(g,h){e=[a,c(0),c(3),c(4),c(6),c(1),c(5),c(2)],d=h,void 0!==(f="function"==typeof d?d.apply(b,e):d)&&(a.exports=f)}(0,function(a,b,c,d,e,f,g,h){"use strict";function i(a){return a&&a.__esModule?a:{default:a}}function j(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var k=i(b),l=i(c),m=i(d),n=i(e),o=i(f),p=i(g),q=i(h),r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},s=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),t=[],u=[],v=[],w={},x="",y=!0,z=5,A="https://www.leanplum.com/api",B="dev.leanplum.com",C=void 0,D={},E=new m.default,F=function(){function a(){j(this,a)}return s(a,null,[{key:"setApiPath",value:function(a){a&&(A=a)}},{key:"setEmail",value:function(b){a._email=b}},{key:"setNetworkTimeout",value:function(a){o.default.setNetworkTimeout(a)}},{key:"setAppIdForDevelopmentMode",value:function(b,c){a._appId=b,a._clientKey=c,a._devMode=!0}},{key:"setAppIdForProductionMode",value:function(b,c){a._appId=b,a._clientKey=c,a._devMode=!1}},{key:"setSocketHost",value:function(a){B=a}},{key:"setDeviceId",value:function(b){a._deviceId=b}},{key:"setAppVersion",value:function(b){a._versionName=b}},{key:"setDeviceName",value:function(b){a._deviceName=b}},{key:"setDeviceModel",value:function(b){a._deviceModel=b}},{key:"setSystemName",value:function(b){a._systemName=b}},{key:"setSystemVersion",value:function(b){a._systemVersion=b}},{key:"setVariables",value:function(b){a._variables=b}},{key:"setRequestBatching",value:function(a,b){y=a,z=b}},{key:"getVariables",value:function(b){return void 0!==a._merged?a._merged:a._variables}},{key:"getVariable",value:function(b){for(var c=a.getVariables(),d=0;d<arguments.length;d++)c=c[arguments.i];return c}},{key:"getVariants",value:function(){return u||[]}},{key:"addStartResponseHandler",value:function(b){v.push(b),a._hasStarted&&b(a._startSuccessful)}},{key:"addVariablesChangedHandler",value:function(b){t.push(b),a._hasReceivedDiffs&&b()}},{key:"removeStartResponseHandler",value:function(a){var b=v.indexOf(a);b>=0&&v.splice(b,1)}},{key:"removeVariablesChangedHandler",value:function(a){var b=t.indexOf(a);b>=0&&t.splice(b,1)}},{key:"start",value:function(b,c,d){"function"==typeof b?(d=b,c={},b=null):"object"==(void 0===b?"undefined":r(b))&&null!==b&&void 0!==b?(d=c,c=b,b=null):"function"==typeof c&&(d=c,c={}),a._userId=b,d&&a.addStartResponseHandler(d);var e=(new l.default).add(k.default.PARAMS.USER_ATTRIBUTES,JSON.stringify(c)).add(k.default.PARAMS.COUNTRY,k.default.VALUES.DETECT).add(k.default.PARAMS.REGION,k.default.VALUES.DETECT).add(k.default.PARAMS.CITY,k.default.VALUES.DETECT).add(k.default.PARAMS.LOCATION,k.default.VALUES.DETECT).add(k.default.PARAMS.SYSTEM_NAME,a._systemName||E.OS).add(k.default.PARAMS.SYSTEM_VERSION,""+(a._systemVersion||"")).add(k.default.PARAMS.BROWSER_NAME,E.browser).add(k.default.PARAMS.BROWSER_VERSION,""+E.version).add(k.default.PARAMS.LOCALE,k.default.VALUES.DETECT).add(k.default.PARAMS.DEVICE_NAME,a._deviceName||E.browser+" "+E.version).add(k.default.PARAMS.DEVICE_MODEL,a._deviceModel||"Web Browser").add(k.default.PARAMS.INCLUDE_DEFAULTS,!1);a._request(k.default.METHODS.START,e,{queued:!0,sendNow:!0,response:function(b){a._hasStarted=!0;var c=a._getLastResponse(b);if(a._isResponseSuccess(c)){if(a._startSuccessful=!0,a._devMode){var d=c[k.default.KEYS.LATEST_VERSION];d&&console.log("A newer version of Leanplum, "+d+", is available. Go to leanplum.com to download it."),WebSocket?a._socketIOConnect():console.log("Your browser doesn't support WebSockets.")}a._setContent(c[k.default.KEYS.VARS],c[k.default.KEYS.VARIANTS],c[k.default.KEYS.ACTION_METADATA]),x=c[k.default.KEYS.TOKEN]}else a._startSuccessful=!1,a._loadDiffs();for(var e=0;e<v.length;e++)v[e](a._startSuccessful)}})}},{key:"startFromCache",value:function(b,c,d){"function"==typeof b?(d=b,c={},b=null):"object"==(void 0===b?"undefined":r(b))&&null!==b&&void 0!==b?(d=c,c=b,b=null):"function"==typeof c&&(d=c,c={}),a._userId=b,d&&a.addStartResponseHandler(d),a._hasStarted=!0,a._startSuccessful=!0,a._devMode&&(WebSocket?a._socketIOConnect():console.log("Your browser doesn't support WebSockets.")),a._loadDiffs();for(var e=0;e<v.length;e++)v[e](a._startSuccessful)}},{key:"stop",value:function(){a._request(k.default.METHODS.STOP,void 0,{sendNow:!0,queued:!0})}},{key:"pauseSession",value:function(){a._request(k.default.METHODS.PAUSE_SESSION,void 0,{sendNow:!0,queued:!0})}},{key:"resumeSession",value:function(){a._request(k.default.METHODS.RESUME_SESSION,void 0,{sendNow:!0,queued:!0})}},{key:"pauseState",value:function(){a._request(k.default.METHODS.PAUSE_STATE,void 0,{queued:!0})}},{key:"resumeState",value:function(){a._request(k.default.METHODS.RESUME_STATE,void 0,{queued:!0})}},{key:"setUserId",value:function(b){a.setUserAttributes(b)}},{key:"setUserAttributes",value:function(b,c){if(void 0===c)if("object"==(void 0===b?"undefined":r(b)))c=b,b=void 0;else if("string"!=typeof b)return void console.log("Leanplum: setUserAttributes expects a string or an object");a._request(k.default.METHODS.SET_USER_ATTRIBUTES,(new l.default).add(k.default.PARAMS.USER_ATTRIBUTES,c?JSON.stringify(c):void 0).add(k.default.PARAMS.NEW_USER_ID,b),{queued:!0}),b&&(a._userId=b,a._saveToLocalStorage(k.default.DEFAULT_KEYS.USER_ID,a._userId))}},{key:"track",value:function(b,c,d,e){"object"==(void 0===c?"undefined":r(c))&&null!==c&&void 0!==c?(e=c,d=void 0,c=void 0):"string"==typeof c?(e=d,d=c,c=void 0):"object"==(void 0===d?"undefined":r(d))&&null!==d&&void 0!==d&&(e=d,d=void 0),a._request(k.default.METHODS.TRACK,(new l.default).add(k.default.PARAMS.EVENT,b).add(k.default.PARAMS.VALUE,c||0).add(k.default.PARAMS.INFO,d).add(k.default.PARAMS.PARAMS,JSON.stringify(e)),{queued:!0})}},{key:"advanceTo",value:function(b,c,d){"object"==(void 0===c?"undefined":r(c))&&null!==c&&void 0!==c&&(d=c,c=void 0),a._request(k.default.METHODS.ADVANCE,(new l.default).add(k.default.PARAMS.STATE,b).add(k.default.PARAMS.INFO,c).add(k.default.PARAMS.PARAMS,JSON.stringify(d)),{queued:!0})}},{key:"isWebPushSupported",value:function(){return!!G&&G.isWebPushSupported()}},{key:"isWebPushSubscribed",value:function(){return G.isWebPushSubscribed()}},{key:"registerForWebPush",value:function(a){return new Promise(function(b,c){return G&&G.isWebPushSupported()?G.register(a,function(a){return a?b(!0):G.subscribeUser()}):c("Leanplum: WebPush is not supported.")})}},{key:"unregisterFromWebPush",value:function(){return G.unsubscribeUser()}},{key:"_setSubscription",value:function(b){b&&a._request(k.default.METHODS.SET_DEVICE_ATTRIBUTES,(new l.default).add(k.default.PARAMS.WEB_PUSH_SUBSCRIPTION,b),{queued:!1,sendNow:!0})}},{key:"_socketIOConnect",value:function(){var b=new n.default,c=!1;b.onopen=function(){if(!c){console.log("Leanplum: Connected to development server.");var d={};d[k.default.PARAMS.APP_ID]=a._appId,d[k.default.PARAMS.DEVICE_ID]=a._deviceId,b.send("auth",d),c=!0}},b.onerror=function(a){console.log("Leanplum: Socket error",a)},b.onmessage=function(c,d){"updateVars"==c?a._request(k.default.METHODS.GET_VARS,(new l.default).add(k.default.PARAMS.INCLUDE_DEFAULTS,!1),{queued:!1,sendNow:!0,response:function(b){var c=a._getLastResponse(b),d=c[k.default.KEYS.VARS],e=c[k.default.KEYS.VARIANTS],f=c[k.default.KEYS.ACTION_METADATA];q.default.isEqual(d,a._diffs)||a._setContent(d,e,f)}}):"getVariables"==c?(a._sendVariables(),b.send("getContentResponse",{updated:!0})):"getActions"==c?b.send("getContentResponse",{updated:!1}):"registerDevice"==c&&alert("Your device has been registered to "+d[0].email+".")},b.onclose=function(){console.log("Leanplum: Disconnected to development server."),c=!1},b.connect(B),setInterval(function(){b.connected||b.connecting||b.connect(B)},5e3)}},{key:"_setContent",value:function(b,c,d){a._diffs=b,u=c,w=d,a._hasReceivedDiffs=!0,a._merged=a._mergeHelper(a._variables,b),a._saveDiffs();for(var e=0;e<t.length;e++)t[e]()}},{key:"_mergeHelper",value:function(b,c){if("number"==typeof c||"boolean"==typeof c||"string"==typeof c)return c;if(null===c||void 0===c)return b;var d=function(a){return function(b){if(a instanceof Array)for(var c=0;c<a.length;c++)b(a[c]);else for(var d in a)({}).hasOwnProperty.call(a,d)&&b(d)}},e=d(b),f=d(c),g=!1;if(null==b&&!(c instanceof Array)){g=null;for(var h in c){if(null===g&&(g=!0),"string"!=typeof h){g=!1;break}if(h.length<3||"["!=h.charAt(0)||"]"!=h.charAt(h.length-1)){g=!1;break}var i=h.substring(1,h.length-1);if(!(""+parseInt(i))==i){g=!1;break}}}if(b instanceof Array||g){var j=[];return e(function(a){j.push(a)}),f(function(b){for(var d=parseInt(b.substring(1,b.length-1)),e=c[b];d>=j.length;)j.push(null);j[d]=a._mergeHelper(j[d],e)}),j}var k={};return e(function(a){null!==c[a]&&void 0!==c[a]||(k[a]=b[a])}),f(function(d){k[d]=a._mergeHelper(null!=b?b[d]:null,c[d])}),k}},{key:"_sendVariables",value:function(){var b={};b[k.default.PARAMS.VARIABLES]=a._variables,a._request(k.default.METHODS.SET_VARS,(new l.default).body(JSON.stringify(b)),{sendNow:!0})}},{key:"_loadDiffs",value:function(){try{a._setContent(JSON.parse(a._getFromLocalStorage(k.default.DEFAULT_KEYS.VARIABLES)||null),JSON.parse(a._getFromLocalStorage(k.default.DEFAULT_KEYS.VARIANTS)||null),JSON.parse(a._getFromLocalStorage(k.default.DEFAULT_KEYS.ACTION_METADATA)||null)),x=a._getFromLocalStorage(k.default.DEFAULT_KEYS.TOKEN)}catch(a){console.log("Leanplum: Invalid diffs: "+a)}}},{key:"_saveDiffs",value:function(){a._saveToLocalStorage(k.default.DEFAULT_KEYS.VARIABLES,JSON.stringify(a._diffs||{})),a._saveToLocalStorage(k.default.DEFAULT_KEYS.VARIANTS,JSON.stringify(u||[])),a._saveToLocalStorage(k.default.DEFAULT_KEYS.ACTION_METADATA,JSON.stringify(w||{})),a._saveToLocalStorage(k.default.DEFAULT_KEYS.TOKEN,x)}},{key:"_saveRequestForLater",value:function(b){var c=a._getFromLocalStorage(k.default.DEFAULT_KEYS.COUNT)||0,d=k.default.DEFAULT_KEYS.ITEM+c;a._saveToLocalStorage(d,JSON.stringify(b)),c++,a._saveToLocalStorage(k.default.DEFAULT_KEYS.COUNT,c)}},{key:"_popUnsentRequests",value:function(){var b=[],c=a._getFromLocalStorage(k.default.DEFAULT_KEYS.COUNT)||0;a._removeFromLocalStorage(k.default.DEFAULT_KEYS.COUNT);for(var d=0;d<c;d++){var e=k.default.DEFAULT_KEYS.ITEM+d;try{var f=JSON.parse(a._getFromLocalStorage(e));b.push(f)}catch(a){}a._removeFromLocalStorage(e)}return b}},{key:"_request",value:function(b,c,d){if(d=d||{},c=c||new l.default,a._deviceId||(a._deviceId=a._getFromLocalStorage(k.default.DEFAULT_KEYS.DEVICE_ID)),!a._deviceId){for(var e="",f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",g=0;g<16;g++)e+=f.charAt(Math.floor(Math.random()*f.length));a._deviceId=e,a._saveToLocalStorage(k.default.DEFAULT_KEYS.DEVICE_ID,e)}a._userId||(a._userId=a._getFromLocalStorage(k.default.DEFAULT_KEYS.USER_ID),a._userId||(a._userId=a._deviceId)),a._saveToLocalStorage(k.default.DEFAULT_KEYS.USER_ID,a._userId);var h=c.attachApiKeys(a._appId,a._clientKey).add(k.default.PARAMS.SDK_VERSION,k.default.SDK_VERSION).add(k.default.PARAMS.DEVICE_ID,a._deviceId).add(k.default.PARAMS.USER_ID,a._userId).add(k.default.PARAMS.ACTION,b).add(k.default.PARAMS.VERSION_NAME,a._versionName).add(k.default.PARAMS.DEV_MODE,a._devMode).add(k.default.PARAMS.TIME,""+(new Date).getTime()/1e3),i=d.success||d.response,j=d.error||d.response;if(!a._appId||!a._clientKey){var m="Leanplum App ID and client key are not set. Make sure you are calling setAppIdForDevelopmentMode or setAppIdForProductionMode before issuing API calls.";return console.error(m),void(j&&j(m))}if(c.body())return void o.default.ajax("POST",A+"?"+h.build(),c.body(),i,j,d.queued);var n=a._devMode||d.sendNow||!y,p=function(){var b=a._popUnsentRequests();if(b.length>0){var c=JSON.stringify({data:b}),e=(new l.default).attachApiKeys(a._appId,a._clientKey).add(k.default.PARAMS.SDK_VERSION,k.default.SDK_VERSION).add(k.default.PARAMS.ACTION,k.default.METHODS.MULTI).add(k.default.PARAMS.TIME,""+(new Date).getTime()/1e3).build();o.default.ajax("POST",A+"?"+e,c,i,j,d.queued)}};if(!n&&z){var q=(new Date).getTime()/1e3;!a._lastRequestTime||q-a._lastRequestTime>=z?(n=!0,a._lastRequestTime=q):a._cooldownTimeout||(a._cooldownTimeout=setTimeout(function(){a._cooldownTimeout=null,a._lastRequestTime=(new Date).getTime()/1e3,p()},1e3*(z-(q-a._lastRequestTime))))}a._saveRequestForLater(h.buildDict()),n&&p()}},{key:"_numResponses",value:function(a){return a&&a.response?a.response.length:0}},{key:"_getResponseAt",value:function(a,b){return a&&a.response?a.response[b]:null}},{key:"_getLastResponse",value:function(b){var c=a._numResponses(b);return c>0?a._getResponseAt(b,c-1):null}},{key:"_isResponseSuccess",value:function(a){return!!a&&!!a.success}},{key:"_getResponseError",value:function(a){if(!a)return null;var b=a.error;return b?b.message:null}},{key:"_getFromLocalStorage",value:function(a){return!1===C?D[a]:localStorage[a]}},{key:"_saveToLocalStorage",value:function(b,c){if(!1===C)return void(D[b]=c);try{localStorage[b]=c}catch(d){C=!1,a._saveToLocalStorage(b,c)}}},{key:"_removeFromLocalStorage",value:function(b){if(!1===C)return void delete D[b];try{localStorage.removeItem(b)}catch(c){C=!1,a._removeFromLocalStorage(b)}}}]),a}(),G=new p.default(F);a.exports=F})}])});