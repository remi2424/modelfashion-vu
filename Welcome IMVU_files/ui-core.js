var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(l,p,n){l instanceof String&&(l=String(l));for(var w=l.length,q=0;q<w;q++){var y=l[q];if(p.call(n,y,q,l))return{i:q,v:y}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;$jscomp.ISOLATE_POLYFILLS=!1;$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(l,p,n){if(l==Array.prototype||l==Object.prototype)return l;l[p]=n.value;return l};$jscomp.getGlobal=function(l){l=["object"==typeof globalThis&&globalThis,l,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var p=0;p<l.length;++p){var n=l[p];if(n&&n.Math==Math)return n}throw Error("Cannot find global object");};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.IS_SYMBOL_NATIVE="function"===typeof Symbol&&"symbol"===typeof Symbol("x");$jscomp.TRUST_ES6_POLYFILLS=!$jscomp.ISOLATE_POLYFILLS||$jscomp.IS_SYMBOL_NATIVE;$jscomp.polyfills={};$jscomp.propertyToPolyfillSymbol={};$jscomp.POLYFILL_PREFIX="$jscp$";var $jscomp$lookupPolyfilledValue=function(l,p){var n=$jscomp.propertyToPolyfillSymbol[p];if(null==n)return l[p];n=l[n];return void 0!==n?n:l[p]};
$jscomp.polyfill=function(l,p,n,w){p&&($jscomp.ISOLATE_POLYFILLS?$jscomp.polyfillIsolated(l,p,n,w):$jscomp.polyfillUnisolated(l,p,n,w))};$jscomp.polyfillUnisolated=function(l,p,n,w){n=$jscomp.global;l=l.split(".");for(w=0;w<l.length-1;w++){var q=l[w];if(!(q in n))return;n=n[q]}l=l[l.length-1];w=n[l];p=p(w);p!=w&&null!=p&&$jscomp.defineProperty(n,l,{configurable:!0,writable:!0,value:p})};
$jscomp.polyfillIsolated=function(l,p,n,w){var q=l.split(".");l=1===q.length;w=q[0];w=!l&&w in $jscomp.polyfills?$jscomp.polyfills:$jscomp.global;for(var y=0;y<q.length-1;y++){var m=q[y];if(!(m in w))return;w=w[m]}q=q[q.length-1];n=$jscomp.IS_SYMBOL_NATIVE&&"es6"===n?w[q]:null;p=p(n);null!=p&&(l?$jscomp.defineProperty($jscomp.polyfills,q,{configurable:!0,writable:!0,value:p}):p!==n&&(void 0===$jscomp.propertyToPolyfillSymbol[q]&&(n=1E9*Math.random()>>>0,$jscomp.propertyToPolyfillSymbol[q]=$jscomp.IS_SYMBOL_NATIVE?
$jscomp.global.Symbol(q):$jscomp.POLYFILL_PREFIX+n+"$"+q),$jscomp.defineProperty(w,$jscomp.propertyToPolyfillSymbol[q],{configurable:!0,writable:!0,value:p})))};$jscomp.polyfill("Array.prototype.findIndex",function(l){return l?l:function(p,n){return $jscomp.findInternal(this,p,n).i}},"es6","es3");$jscomp.arrayIteratorImpl=function(l){var p=0;return function(){return p<l.length?{done:!1,value:l[p++]}:{done:!0}}};$jscomp.arrayIterator=function(l){return{next:$jscomp.arrayIteratorImpl(l)}};
$jscomp.makeIterator=function(l){var p="undefined"!=typeof Symbol&&Symbol.iterator&&l[Symbol.iterator];return p?p.call(l):$jscomp.arrayIterator(l)};
$jscomp.polyfill("Promise",function(l){function p(){this.batch_=null}function n(m){return m instanceof q?m:new q(function(u,x){u(m)})}if(l&&(!($jscomp.FORCE_POLYFILL_PROMISE||$jscomp.FORCE_POLYFILL_PROMISE_WHEN_NO_UNHANDLED_REJECTION&&"undefined"===typeof $jscomp.global.PromiseRejectionEvent)||!$jscomp.global.Promise||-1===$jscomp.global.Promise.toString().indexOf("[native code]")))return l;p.prototype.asyncExecute=function(m){if(null==this.batch_){this.batch_=[];var u=this;this.asyncExecuteFunction(function(){u.executeBatch_()})}this.batch_.push(m)};
var w=$jscomp.global.setTimeout;p.prototype.asyncExecuteFunction=function(m){w(m,0)};p.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var m=this.batch_;this.batch_=[];for(var u=0;u<m.length;++u){var x=m[u];m[u]=null;try{x()}catch(z){this.asyncThrow_(z)}}}this.batch_=null};p.prototype.asyncThrow_=function(m){this.asyncExecuteFunction(function(){throw m;})};var q=function(m){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];this.isRejectionHandled_=!1;var u=this.createResolveAndReject_();
try{m(u.resolve,u.reject)}catch(x){u.reject(x)}};q.prototype.createResolveAndReject_=function(){function m(z){return function(C){x||(x=!0,z.call(u,C))}}var u=this,x=!1;return{resolve:m(this.resolveTo_),reject:m(this.reject_)}};q.prototype.resolveTo_=function(m){if(m===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(m instanceof q)this.settleSameAsPromise_(m);else{a:switch(typeof m){case "object":var u=null!=m;break a;case "function":u=!0;break a;default:u=!1}u?this.resolveToNonPromiseObj_(m):
this.fulfill_(m)}};q.prototype.resolveToNonPromiseObj_=function(m){var u=void 0;try{u=m.then}catch(x){this.reject_(x);return}"function"==typeof u?this.settleSameAsThenable_(u,m):this.fulfill_(m)};q.prototype.reject_=function(m){this.settle_(2,m)};q.prototype.fulfill_=function(m){this.settle_(1,m)};q.prototype.settle_=function(m,u){if(0!=this.state_)throw Error("Cannot settle("+m+", "+u+"): Promise already settled in state"+this.state_);this.state_=m;this.result_=u;2===this.state_&&this.scheduleUnhandledRejectionCheck_();
this.executeOnSettledCallbacks_()};q.prototype.scheduleUnhandledRejectionCheck_=function(){var m=this;w(function(){if(m.notifyUnhandledRejection_()){var u=$jscomp.global.console;"undefined"!==typeof u&&u.error(m.result_)}},1)};q.prototype.notifyUnhandledRejection_=function(){if(this.isRejectionHandled_)return!1;var m=$jscomp.global.CustomEvent,u=$jscomp.global.Event,x=$jscomp.global.dispatchEvent;if("undefined"===typeof x)return!0;"function"===typeof m?m=new m("unhandledrejection",{cancelable:!0}):
"function"===typeof u?m=new u("unhandledrejection",{cancelable:!0}):(m=$jscomp.global.document.createEvent("CustomEvent"),m.initCustomEvent("unhandledrejection",!1,!0,m));m.promise=this;m.reason=this.result_;return x(m)};q.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var m=0;m<this.onSettledCallbacks_.length;++m)y.asyncExecute(this.onSettledCallbacks_[m]);this.onSettledCallbacks_=null}};var y=new p;q.prototype.settleSameAsPromise_=function(m){var u=this.createResolveAndReject_();
m.callWhenSettled_(u.resolve,u.reject)};q.prototype.settleSameAsThenable_=function(m,u){var x=this.createResolveAndReject_();try{m.call(u,x.resolve,x.reject)}catch(z){x.reject(z)}};q.prototype.then=function(m,u){function x(E,F){return"function"==typeof E?function(K){try{z(E(K))}catch(G){C(G)}}:F}var z,C,J=new q(function(E,F){z=E;C=F});this.callWhenSettled_(x(m,z),x(u,C));return J};q.prototype.catch=function(m){return this.then(void 0,m)};q.prototype.callWhenSettled_=function(m,u){function x(){switch(z.state_){case 1:m(z.result_);
break;case 2:u(z.result_);break;default:throw Error("Unexpected state: "+z.state_);}}var z=this;null==this.onSettledCallbacks_?y.asyncExecute(x):this.onSettledCallbacks_.push(x);this.isRejectionHandled_=!0};q.resolve=n;q.reject=function(m){return new q(function(u,x){x(m)})};q.race=function(m){return new q(function(u,x){for(var z=$jscomp.makeIterator(m),C=z.next();!C.done;C=z.next())n(C.value).callWhenSettled_(u,x)})};q.all=function(m){var u=$jscomp.makeIterator(m),x=u.next();return x.done?n([]):new q(function(z,
C){function J(K){return function(G){E[K]=G;F--;0==F&&z(E)}}var E=[],F=0;do E.push(void 0),F++,n(x.value).callWhenSettled_(J(E.length-1),C),x=u.next();while(!x.done)})};return q},"es6","es3");$jscomp.polyfill("Array.prototype.find",function(l){return l?l:function(p,n){return $jscomp.findInternal(this,p,n).v}},"es6","es3");$jscomp.initSymbol=function(){};
$jscomp.polyfill("Symbol",function(l){if(l)return l;var p=function(y,m){this.$jscomp$symbol$id_=y;$jscomp.defineProperty(this,"description",{configurable:!0,writable:!0,value:m})};p.prototype.toString=function(){return this.$jscomp$symbol$id_};var n="jscomp_symbol_"+(1E9*Math.random()>>>0)+"_",w=0,q=function(y){if(this instanceof q)throw new TypeError("Symbol is not a constructor");return new p(n+(y||"")+"_"+w++,y)};return q},"es6","es3");
$jscomp.polyfill("Symbol.iterator",function(l){if(l)return l;l=Symbol("Symbol.iterator");for(var p="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),n=0;n<p.length;n++){var w=$jscomp.global[p[n]];"function"===typeof w&&"function"!=typeof w.prototype[l]&&$jscomp.defineProperty(w.prototype,l,{configurable:!0,writable:!0,value:function(){return $jscomp.iteratorPrototype($jscomp.arrayIteratorImpl(this))}})}return l},"es6",
"es3");$jscomp.iteratorPrototype=function(l){l={next:l};l[Symbol.iterator]=function(){return this};return l};$jscomp.iteratorFromArray=function(l,p){l instanceof String&&(l+="");var n=0,w=!1,q={next:function(){if(!w&&n<l.length){var y=n++;return{value:p(y,l[y]),done:!1}}w=!0;return{done:!0,value:void 0}}};q[Symbol.iterator]=function(){return q};return q};
$jscomp.polyfill("Array.prototype.values",function(l){return l?l:function(){return $jscomp.iteratorFromArray(this,function(p,n){return n})}},"es8","es3");$jscomp.checkStringArgs=function(l,p,n){if(null==l)throw new TypeError("The 'this' value for String.prototype."+n+" must not be null or undefined");if(p instanceof RegExp)throw new TypeError("First argument to String.prototype."+n+" must not be a regular expression");return l+""};
$jscomp.polyfill("String.prototype.startsWith",function(l){return l?l:function(p,n){var w=$jscomp.checkStringArgs(this,p,"startsWith");p+="";var q=w.length,y=p.length;n=Math.max(0,Math.min(n|0,w.length));for(var m=0;m<y&&n<q;)if(w[n++]!=p[m++])return!1;return m>=y}},"es6","es3");$jscomp.polyfill("Array.prototype.keys",function(l){return l?l:function(){return $jscomp.iteratorFromArray(this,function(p){return p})}},"es6","es3");
module({"@IMQ":"@IMQ"},function(l){var p=function(){return Handlebars.template({compiler:[5,">= 2.0.0"],main:function(h,a,b,d){var c;b=this.escapeExpression;return'<header class="dialog-header">\n    <h3 class="dialog-title">'+b((c=a.title||h&&h.title,"function"===typeof c?c.call(h,{name:"title",hash:{},data:d}):c))+'</h3>\n    <a href="#" class="dialog-x"><span>&times;</span></a>\n</header>\n<section class="dialog-body"></section>'},useData:!0})}({}),n=function(h){var a=IMVU.NamedView;return a.extend("UiView",
{initialize:function(b){a.prototype.initialize.call(this,b);this.__serviceProvider=b.serviceProvider;this.__$parentElement=b.$parentElement;this.__$replaceElement=b.$replaceElement;this.__$prependElement=b.$prependElement},delete:function(){this.remove()},addToDOM:function(){var b=this.__$parentElement||this.__$replaceElement||this.__$prependElement||void 0;if(!b)throw new ReferenceError("Please provide $parentElement or $replaceElement or $prependElement to attach presenter's element to the DOM.");
if(!b.length){var d="$parentElement";this.__$replaceElement?d="$replaceElement":this.__$prependElement&&(d="$prependElement");(b=b.data("debug-selector")||"")&&(b=" Attempted selector: "+b);throw Error("Cannot attach element to the DOM, provided "+d+" does not exist."+b);}this.__$parentElement?(this.preRender(this.__$parentElement,"append"),this.__$parentElement.append(this.$el)):this.__$replaceElement?(this.preRender(this.__$replaceElement,"replace"),this.__$replaceElement.replaceWith(this.$el)):
this.__$prependElement&&(this.preRender(this.__$prependElement,"prepend"),this.__$prependElement.prepend(this.$el));this.render()},$:function(b){var d=a.prototype.$.call(this,b);"string"===typeof b&&d.data("debug-selector",b);return d},preRender:function(b,d){},showPostRender:function(){}})}({}),w=function(h){var a=h.UiView,b=function(c){for(var e=this,g=function(f){this["__"+f]=this["__"+f]||c[f]}.bind(this);e&&e.constructor!==a;)_.each(e.dependencies,g),e=Object.getPrototypeOf(e)},d=a.extend("UiContext",
{dependencies:["modelCache","Promise","timer"],contentAreas:{},"static extend":function(c,e,g){e=e||{};if(_.has(e,"events"))throw new ReferenceError('Do not use the "events" object, please pass "trackedEvents" function that returns an array of objects.');return IMVU.BaseClass.extend.apply(this,arguments)},initialize:function(c){this.__perfStartTime=c.perfStartTime;b.call(this,c);a.prototype.initialize.call(this,c);this.__hasRenderedPromise=new this.__Promise(function(e){this.__hasRenderedResolver=
e}.bind(this));this.__renderComplete=null;this.__renderGatingPromises=[];this.__numWorkers=0;this.__childContexts=[];this.__trackedModels=[];this.__blockedEvents={};this.__useEventWhitelist=IMVU.optionalProperty(c.serviceProvider.services,"useEventWhitelist",!1);this.__recordShown=!this.__useEventWhitelist||this.__recordShown;this.__recordHidden=!this.__useEventWhitelist||this.__recordHidden;this.setParentUiContext(c.parentUiContext);if(this.uiAttributes&&!this.hasOwnProperty("uiAttributes"))throw Error("Do not define uiAttributes statically.");
this.on("shown",this.__onShown);this.on("hidden",this.__onHidden)},delete:function(){var c=this.el.querySelectorAll("img:not([src=''])");c.length&&window.setTimeout(function(){for(var e=0;e<c.length;e++)c[e].src=""}.bind(this));this.__deleted||(this.__parentUiContext&&this.__parentUiContext.removeChildContext(this),_.each(this.__childContexts,function(e,g){e["delete"]()}.bind(this)),this.__childContexts=[],this.__deleted=!0,a.prototype["delete"].call(this),this.trigger("hidden"),this.undelegateEvents(),
this.off())},getHasRenderedPromise:function(){return this.__hasRenderedPromise},getRenderComplete:function(){return this.__renderComplete},__setAsRendered:function(c){this.__hasRenderedResolver.resolve(c);this.__renderComplete=!0},__setAsRenderFailed:function(c){this.__hasRenderedResolver.reject(c);this.__renderComplete=!1},__addRenderGatingPromise:function(c){this.__renderGatingPromises.push(c)},__waitOnRenderGatingPromises:function(c){var e=this,g=this.__renderGatingPromises.length;return this.__Promise.every(this.__renderGatingPromises).then(function(){var f=
c&&c.success?c.success:null;g!=e.__renderGatingPromises.length?e.__waitOnRenderGatingPromises(c):e.__setAsRendered(f)}).catch(function(f){e.__setAsRenderFailed(c&&c.failure?c.failure:null)})},setContent:function(c,e,g){var f=this.__getContentAreaSelector(c);if(!f)throw new TypeError("Content area does not exist: "+c);c=this.$(f);if(e.prototype instanceof d)return this.createChildContext(e,_.extend(g||{},{$parentElement:c}));e instanceof Function?c.append(e(g)):c.append(e)},__getContentAreaSelector:function(c){for(var e=
this,g=null;e&&!g;){if(e.hasOwnProperty("contentAreas")&&e.contentAreas[c]){g=e.contentAreas[c];break}e=Object.getPrototypeOf(e)}return g},getParentUiContext:function(){return this.__parentUiContext},setParentUiContext:function(c){this.__parentUiContext=c},isDeleted:function(){return!!this.__deleted},addToDOM:function(){a.prototype.addToDOM.call(this);this.trigger("shown")},preRender:function(c,e){a.prototype.preRender.call(this,c,e);if(this.__parentUiContext&&!this.__parentUiContext.$el.is(c)&&!this.__parentUiContext.$el.has(c).length)throw Error("ChildContext's $parentElement or $replaceElement or $prependElement is outside of its parentUiContext's $el.");
},hide:function(){this.$el.hide();this.trigger("hidden")},show:function(){this.$el.show();this.trigger("shown")},children:function(){return this.__childContexts},createChildContext:function(c,e){e=e||{};e.parentUiContext=this;c=this.__serviceProvider.create(c,e);this.__childContexts.push(c);return c},removeChildContext:function(c){this.__childContexts=_.without(this.__childContexts,c)},track:function(c,e,g){if(!c)throw Error("Attempted to track a falsy value when a model was expected. Got: "+IMVU.repr(c));
if(-1!==_.findIndex(this.__trackedModels,function(f){return f.model===c}))return c;this.__trackedModels.push({model:c,hints:e,resolution:g});this.__isShown&&(void 0===e?this.__modelCache.activate(c):this.__modelCache.activate(this,c,e,g));return c},untrack:function(c){var e=_.findIndex(this.__trackedModels,function(g){return g.model===c});-1!==e&&(this.__trackedModels.splice(e,1),this.__modelCache.deactivate(c))},__getUiContext:function(c){if(_.isUndefined(this.uiContextName))throw Error("UiContext must define uiContextName");
if("string"!==typeof this.uiContextName)throw Error("uiContextName ("+IMVU.repr(this.uiContextName)+") must be a string.");this.__validateName(this.uiContextName);return this.uiContextName+(c?"."+c:"")},__validateName:function(c){if(-1===c.search(/^[a-z|_|0-9]+$/))throw Error('UiContext invalid identifier: "'+c+'".  Use only lowercase letters and underscores.');},__getUiApplication:function(){if(_.isUndefined(this.uiApplication))throw Error("Top-level UiContext must define uiApplication");return this.uiApplication},
__getUiPlatform:function(){return _.isUndefined(this.uiPlatform)?"default":this.uiPlatform},__getUiAttributes:function(c){_.each(this.uiAttributes,function(e,g){_.isUndefined(c[g])&&(c[g]=e)});return c},debounce:function(c,e,g,f){g=void 0===g?!1:g;f=void 0===f?this:f;var k,r,t,v,B=function(){var A=this.__timer.getTime()-t;A<e&&0<=A?k=this.__timer.setTimeout(B,e-A):(k=null,g||(v=c.apply(f,r),k||(f=r=null)))}.bind(f);return function(){r=arguments;t=this.__timer.getTime();var A=g&&!k;k||(k=this.__timer.setTimeout(B,
e));A&&(v=c.apply(f,r),f=r=null);return v}.bind(f)},trackedEvents:function(){return[]},isShown:function(){return this.__isShown},events:function(){var c={};_.each(this.trackedEvents(),function(e){var g=e.type;_.isUndefined(e.selector)||(g+=" "+e.selector);c[g]=function(f){var k=!!e.waitOnPromise;if(k&&this.__blockedEvents[g])return!1;if(!e.name)throw Error("trackedEvent needs a name: "+JSON.stringify(e));var r=$(f.currentTarget);if(r.hasClass("selected")||r.is(":selected")||r.is(":disabled"))return!1;
var t=e.attributes||{};_.isFunction(t)&&(t=t(r));this.__validateName(e.name);t.name=e.name;t.selector=e.selector;this.__serviceProvider.get("eventBus").trigger(e.type+"_handled");this.__recordEvent(e.type,t);e.allowBubble||f.stopPropagation();f=("string"===typeof e.handler?this[e.handler]:e.handler).call(this,f);k&&f&&f.then&&(this.__blockedEvents[g]=f,r.prop("disabled",!0),k=function(){r.prop("disabled",!1);delete this.__blockedEvents[g]}.bind(this),f.then(k).catch(k))}.bind(this);void 0!==e.debounce&&
(c[g]=this.debounce(c[g],e.debounce,e.debounceImmediate))}.bind(this));return c},__urlId:function(c){return _.last(c.split("/"))},__parseRGBColor:function(c){c=c.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);delete c[0];for(var e=1;3>=e;++e)c[e]=parseInt(c[e],10).toString(16),c[e]=1===c[e].length?"0"+c[e]:c[e];return"#"+c.join("").toUpperCase()},IGNORED_EVENTS:"scroll mousemove mousein mouseenter mouseout mouseleave mousewheel touchmove keypress keydown keyup".split(" "),EVENT_WHITELIST:"click submit change shown hidden taxonomy".split(" "),
__recordEvent:function(c,e,g,f){f=void 0===f?null:f;if(this.__isShown&&!_.contains(this.IGNORED_EVENTS,c)&&(e=e||{},g=g||"",e=this.__getUiAttributes(e),!this.__useEventWhitelist||e.record||_.contains(this.EVENT_WHITELIST,c))){if("string"!==typeof g)throw Error("subContext ("+IMVU.repr(g)+") must be a string.");_.isUndefined(this.__parentUiContext)?(e.name&&this.__validateName(e.name),delete e.record,f=f||this.__getUiApplication(),this.__serviceProvider.get("uiEventReporter").recordEvent(f,this.__getUiPlatform(),
this.__getUiContext(g),c,e)):this.__parentUiContext.__recordEvent(c,e,this.__getUiContext(g),f)}},__onShown:function(){this.$el.is(":visible")&&(_.isUndefined(this.__parentUiContext)||this.__parentUiContext.isShown())&&(this.__isShown||_.each(this.__trackedModels,function(c){this.__modelCache.activate(this,c.model,c.hints,c.resolution)}.bind(this)),this.__isShown=!0,this.__recordShown&&this.__recordEvent("shown"),this.__triggerChildContextsShown())},__onHidden:function(){if(this.$el.is(":visible"))throw Error('Tried to trigger a "hidden" event on a *visible* element.');
this.__isShown&&_.each(this.__trackedModels,function(c){this.__modelCache.deactivate(this,c.model)}.bind(this));this.__triggerChildContextsHidden();this.__recordHidden&&this.__recordEvent("hidden");this.__isShown=!1},__triggerChildContextsShown:function(){_.each(this.__childContexts,function(c){c.isShown&&!c.isShown()&&c.trigger("shown")})},__triggerChildContextsHidden:function(){_.each(this.__childContexts,function(c){c.isShown&&c.isShown()&&c.trigger("hidden")})},__triggerChildContexts:function(c){_.each(this.__childContexts,
function(e){e.trigger(c)})},doWork:function(c){this.__numWorkers++;return this.doWorkStep(c,0)},doWorkStep:function(c,e){var g=Array.prototype.slice.apply(arguments);g=g.slice(2);if(e===c.length)return this.__numWorkers--,this.__Promise.resolve();if(this.__deleted)return this.__Promise.resolve();g=c[e].apply(null,g);void 0===g?g=this.__Promise.resolve():"object"!==typeof g||g.then||(g=this.__Promise.resolve(g));return g.then(function(){var f=Array.prototype.slice.apply(arguments);if(this.__deleted)this["delete"]();
f=[c,++e].concat(f);return this.doWorkStep.apply(this,f)}.bind(this))}});return d}({UiView:n});p=function(h){return h.UiContext.extend("ModalDialog",{uiContextName:"modal_dialog_generic",className:"modal-dialog-generic",dependencies:["window"],hasCloseButton:!0,initialize:function(a){h.UiContext.prototype.initialize.call(this,a);this.serviceProvider=a.serviceProvider;this.dialogManager=a.dialogManager;this.finished=new Promise(function(b,d){this.promiseResolver={resolve:b,reject:d}}.bind(this));a=
this["delete"].bind(this);this.finished.then(a,a);this.$el.attr("data-ui-role","modal-dialog")},render:function(){this.$el.html(h.template({title:this.title||""}));this.$(".dialog-x").on("click",this.__onClose.bind(this));this.$(".dialog-x").toggle(this.hasCloseButton);this.postRender();this.__focusPrimaryButton()},show:function(){h.UiContext.prototype.show.call(this);this.__focusPrimaryButton()},__onClose:function(a){a.preventDefault();this.__recordEvent("click",{name:"dialog_close"});this.hide();
this.promiseResolver.reject()},__focusPrimaryButton:function(){var a=this.$("button.primary");1<a.length?a.blur():a.first().focus()}})}({template:p,UiContext:w});var q=function(){return Handlebars.template({compiler:[5,">= 2.0.0"],main:function(h,a,b,d){var c;b=this.escapeExpression;return"<p>"+b((c=a.text||h&&h.text,"function"===typeof c?c.call(h,{name:"text",hash:{},data:d}):c))+'</p>\n           <footer class="dialog-footer">\n                  <button class="btn btn-primary primary" data-confirm="ok">'+
b((c=a.ok||h&&h.ok,"function"===typeof c?c.call(h,{name:"ok",hash:{},data:d}):c))+"</button>\n              </footer>\n"},useData:!0})}({});q=function(h){return h.ModalDialog.extend("AlertDialog",{uiContextName:"alert_dialog",className:"alert-dialog",trackedEvents:function(){return[{type:"click",selector:'[data-confirm="ok"]',name:"confirm",handler:"__onConfirm"}]},initialize:function(a){this.title=a.title;this.text=a.text;this.ok=a.ok;h.ModalDialog.prototype.initialize.call(this,a);this.addToDOM()},
postRender:function(){this.$el.find(".dialog-body").html(h.template({text:this.text,ok:this.ok}))},__onConfirm:function(){this.promiseResolver.resolve();this.delete()}})}({ModalDialog:p,template:q});var y=function(){return{_initSyncing:function(){this._hasData=this._successfulResponseReceived=!1;this._outstandingRequests=0;this._lastResponseError=!1;this._lastResponseErrorContents=void 0;this.on("successfulResponseReceived",function(){this._successfulResponseReceived=!0;this.trigger("populated")},
this)},isPopulated:function(){return this._successfulResponseReceived},isSyncing:function(){return 0<this._outstandingRequests},isError:function(){return this._lastResponseError},getError:function(){return this._lastResponseErrorContents},whenPopulated:function(h,a){if(this._successfulResponseReceived)h.call(a||this,this);else{var b=function(){h.call(a||this,this);this.off("populated",b)};this.on("populated",b)}},_onRequestSent:function(){this._outstandingRequests+=1;1===this._outstandingRequests&&
this.trigger("syncing",!0)},_onResponseReceived:function(h,a){--this._outstandingRequests;0===this._outstandingRequests&&this.trigger("syncing",!1);h&&this.trigger("successfulResponseReceived");h=!h;h!==this._lastResponseError&&(this._lastResponseErrorContents=(this._lastResponseError=h)?a:void 0,this.trigger("error",h,this._lastResponseErrorContents))},_clearState:function(){var h=this._lastResponseError;this._successfulResponseReceived=this._lastResponseError=!1;this._lastResponseErrorContent=void 0;
h&&this.trigger("error",!1,void 0)}}}({}),m=function(h){return{makeRequest:function(a,b,d,c,e,g){return a[b].apply(a,void 0===c?[d,e,g]:[d,c,e,g])},flatten:function(a){function b(d,c){var e={};_(c).each(function(g,f){_.isObject(g)&&Object.getPrototypeOf(g)===Object.prototype?_(e).extend(b(d+f+".",g)):e[d+f]=g});return e}return b("",a)},unflatten:function(a){var b={};_(a).each(function(d,c,e){e=e.split(".");var g=e.pop();e.reduce(function(f,k){void 0===f[k]&&(f[k]={});return f[k]},d)[g]=c}.bind(null,
b));return b},arrayUnique:function(a){for(var b={},d=[],c=a.length,e=0,g=0;g<c;g++){var f=a[g];1!==b[f]&&(b[f]=1,d[e++]=f)}return d}}}({}),u=function(h){var a=IMVU.NamedModel.prototype,b=IMVU.NamedModel.extend("RestModel",{dependencies:["modelCache","Promise","rest"],initialize:function(d,c){a.initialize.apply(this,[d,c]);this.modelCache=c.modelCache;this._lastResponseError=this._successfulResponseReceived=!1;this._outstandingRequests=0;this.clear({silent:!0});this.set(h.RestUtil.flatten(d),{silent:!0});
this.rest=IMVU.requireProperty(c,"rest");this.Promise=IMVU.requireProperty(c,"Promise");this._initSyncing()},methodMap:{create:"post",read:"get",update:"post",delete:"delete"},create:function(){throw Error("Do not create via RestModel.  Instead, use a GraphRoot or restModelFactory:createModel()");},set:function(d){if(_.isObject(d)){var c=[].slice.call(arguments,0);c[0]=h.RestUtil.flatten(c[0]);return a.set.apply(this,c)}return a.set.apply(this,arguments)},sync:function(d,c,e){var g=IMVU.requireProperty(this.methodMap,
d),f=e.url||this.url();d=e.data?e.data:"create"===d||"update"===d?c.toJSON():void 0;this._onRequestSent();h.RestUtil.makeRequest(this.rest,g,f,d,e,function(k,r,t,v){void 0===k?(c.id||(c.id=v),e.success(c,r,e)):(k.code=t.status,e.error&&e.error(k,t,e));c._onResponseReceived(void 0===k,k)})},fetch:function(){this._clearState();a.fetch.apply(this,arguments)},patch:function(d,c){c=c||{};_(c).defaults({success:function(){},error:function(){}});var e={};_(d).each(function(g){e[g]=this.get(g)},this);d=h.RestUtil.unflatten(e);
this.sync("update",this,_(c).extend({data:d}))},save:function(d,c){return new this.Promise(function(e){c=c||{};c.data=d;var g=c.success,f=c.error;c.success=function(k,r,t){g&&g(k,r,t);e.resolve(k)};c.error=function(k,r,t){f&&f(k,r,t);e.reject(k)};a.save.call(this,d,c)}.bind(this))},parse:function(d,c){if("undefined"===typeof d)return{};c=this.relations;this.relations=d.relations;this.updates=d.updates;this.trigger("change:relations",c,this.relations);return h.RestUtil.flatten(d.data)},url:function(){return this.id||
a.url.call(this)},toJSON:function(){var d=h.RestUtil.unflatten(a.toJSON.call(this));delete d.id;delete d.relations;return d},invalidate:function(){this.modelCache.invalidate(this.id)},release:function(){this.rest.invalidate(this.id);this.modelCache.release(this)},destroy:function(d){return new this.Promise(function(c){d=d||{};d.wait=_.isUndefined(d.wait)?!0:d.wait;var e=d.success,g=d.error;d.success=function(f,k,r){e&&e(f,k,r);c.resolve()};d.error=function(f,k,r){g&&g(f,k,r);c.reject(f)};a.destroy.call(this,
d)}.bind(this))},populated:function(){return new this.Promise(function(d){if(this.isError())d.reject({isError:!0,contents:this.getError()});else{var c=function(e,g){this.off("error",c);d.reject({isError:e,contents:g})}.bind(this);this.on("error",c);this.whenPopulated(function(){this.off("error",c);d.accept(this)}.bind(this))}}.bind(this))}});_.extend(b.prototype,h.RestSyncingMixin);return b}({RestSyncingMixin:y,RestUtil:m}),x=function(h){var a=h.RestModel.prototype;return function(b){var d;if(!(d=
b))throw new ReferenceError("Must specify type");b=d;return h.RestModel.extend("CollectionItemModel",{initialize:function(c,e){this.options=e;a.initialize.call(this,c,e)},data:function(){return this.options.modelCache.get(this.get("data"),b)},delete:function(c){this.rest["delete"](this.get("id"),c)}},{modelName:"CollectionItem"})}}({RestModel:u}),z=function(){return Handlebars.template({compiler:[5,">= 2.0.0"],main:function(h,a,b,d){var c;b=this.escapeExpression;return"<p>"+b((c=a.text||h&&h.text,
"function"===typeof c?c.call(h,{name:"text",hash:{},data:d}):c))+'</p>\n<footer class="dialog-footer">\n    <button class="btn btn-secondary secondary" data-confirm="no">'+b((c=a.no||h&&h.no,"function"===typeof c?c.call(h,{name:"no",hash:{},data:d}):c))+'</button>\n    <button class="btn btn-primary primary" data-confirm="yes">'+b((c=a.yes||h&&h.yes,"function"===typeof c?c.call(h,{name:"yes",hash:{},data:d}):c))+"</button>\n</footer>"},useData:!0})}({});z=function(h){return h.ModalDialog.extend("ConfirmDialog",
{uiContextName:"confirm_dialog",className:"confirm-dialog",trackedEvents:function(){return[{type:"click",selector:'[data-confirm="yes"]',name:"confirm",handler:"__onConfirm"},{type:"click",selector:'[data-confirm="no"]',name:"deny",handler:"__onDeny"}]},initialize:function(a){this.title=a.title;this.text=a.text;this.yes=a.yes;this.no=a.no;h.ModalDialog.prototype.initialize.call(this,a);this.addToDOM()},postRender:function(){this.$el.find(".dialog-body").html(h.template({text:this.text,yes:this.yes,
no:this.no}))},__onConfirm:function(){this.promiseResolver.resolve();this.hide()},__onDeny:function(){this.promiseResolver.reject();this.hide()}})}({ModalDialog:p,template:z});var C=function(h){return h.UiContext.extend("DialogManager",{uiContextName:"dialog_manager",tagName:"section",className:"dialog-manager",initialize:function(a){h.UiContext.prototype.initialize.call(this,a);this.$parentElement=a.$parentElement;this.serviceProvider=a.serviceProvider;this.$el.attr("data-ui-role","dialog-manager");
this.addToDOM();this.__stack=[]},render:function(){this.$el.html('<div class="transparent-overlay">');this.$container=this.$(".transparent-overlay");this.$el.hide();$("body").append(this.$el)},showDialog:function(a,b){this.__isShown||this.show();a=this.__createDialog(a,b||{});1<this.__stack.length&&this.__stack[this.__stack.length-2].hide();return a},replaceDialog:function(a,b){a=this.showDialog(a,b);1<this.__stack.length&&(b=this.__stack[this.__stack.length-2],b.promiseResolver.reject(),this.__stack=
_.without(this.__stack,b));return a},alert:function(a){return this.showDialog(h.AlertDialog,a)},confirm:function(a){return this.showDialog(h.ConfirmDialog,a)},closeAll:function(){for(var a=this.__stack.length-1;0<=a;a--){var b=this.__stack[a];b.hide();b.promiseResolver.reject()}this.hide();this.__stack=[]},show:function(){h.UiContext.prototype.show.call(this);$("html").addClass("dialog-over")},hide:function(){this.$parentElement.append(this.$el);$("html").removeClass("dialog-over");h.UiContext.prototype.hide.call(this)},
__createDialog:function(a,b){a=this.createChildContext(a,_(b||{}).extend({$parentElement:this.$container,dialogManager:this}));this.__stack.push(a);a.on("hidden",this.__onDialogHidden.bind(this,a));return a},__onDialogHidden:function(a){_.last(this.__stack)===a&&this.__stack.pop();0===this.__stack.length?this.hide():_.last(this.__stack).show()},isShowingDialog:function(){return 0<this.__stack.length},delete:function(){_(this.__stack).each(function(a){a.off()});h.UiContext.prototype["delete"].call(this)},
hasFocus:function(){return this.$el.find(document.activeElement).length}})}({AlertDialog:q,ConfirmDialog:z,ModalDialog:p,UiContext:w}),J=function(h){return h.UiContext.extend("ListPresenter",{tagName:"ul",uiContextName:"list_presenter",dependencies:["collection"],initialize:function(a){this.__addedItems=[];if(!this.itemFactory)throw Error("Please provide a factory which will be used to create list items.");h.UiContext.prototype.initialize.call(this,a);this.args=a;this.collection=a.collection;this.__registry=
{};this.addToDOM();this.$itemContainer=this.$itemContainer||this.$el;this.collection.on("add",this.onAdd,this);this.collection.on("remove",this.onRemove,this);this.collection.on("reset",this.onReset,this);this.collection.on("sort",this.onSort,this);this.onReset()},delete:function(){this.collection.off("add",this.onAdd,this);this.collection.off("remove",this.onRemove,this);this.collection.off("reset",this.onReset,this);this.collection.off("sort",this.onSort,this);h.UiContext.prototype["delete"].call(this)},
onAdd:function(a,b,d){b=this.createChildContext(this.itemFactory,_(this.args).extend({model:a,$parentElement:this.$itemContainer}));this.__addedItems.push(b);this.args.reverse&&this.$itemContainer.prepend(b.$el);this.__registry[a.cid]=b;b.on("all",function(c,e){"hidden"!==c&&"visible"!==c&&"shown"!==c&&this.trigger.apply(this,_.map(arguments,function(g,f){return g}))},this)},getItems:function(){return this.__addedItems},onRemove:function(a,b,d){b=this.__registry[a.cid];delete this.__registry[a.cid];
b["delete"]()},onReset:function(a,b){var d=[];this.__addedItems=[];a=this.__detach();b=_.clone(this.__registry);_(b).each(function(c,e){if(void 0===this.collection.get({cid:e}))this.onRemove(c.model)},this);this.collection.each(function(c){void 0===this.__registry[c.cid]&&(this.onAdd(c),d.push(c))},this);this.__arrangeAndReattach(a);_.each(d,function(c){this.__registry[c.cid].trigger("shown")}.bind(this))},getContextByModel:function(a){return this.__registry[a.cid]},__detach:function(){var a=this.el.nextSibling,
b=this.el.parentNode;if(b)return b.removeChild(this.el),{parentNode:b,siblingNode:a}},__arrangeAndReattach:function(a){this.collection.each(function(b){this.__registry[b.cid]&&this.__registry[b.cid].$el&&(this.args.reverse?this.__registry[b.cid].$el.detach().prependTo(this.$itemContainer):this.__registry[b.cid].$el.detach().appendTo(this.$itemContainer))},this);a&&a.parentNode.insertBefore(this.el,a.siblingNode)},onSort:function(a,b){a=this.__detach();this.__arrangeAndReattach(a)}})}({UiContext:w}),
E=function(h){var a=h.ListPresenter;return a.extend("EdgeCollectionPresenter",{uiContextName:"edge_collection_presenter",triggerNextPage:5,dependencies:["Promise","window"],initialize:function(b){this.__perfStartTime=b.perfStartTime;this.__scroller=b.scroller?$(b.scroller):null;this.__window=b.window;this.__namespace="edgecollectionpresenter_"+b.collection.url.replace(/[\(\)\?\+\*\[\]]/g,"_");a.prototype.initialize.call(this,b)},delete:function(){a.prototype["delete"].call(this);this.$el.off();this.collection.off(null,
null,this);$(this.__scroller).off("scroll."+this.__namespace)},render:function(){this.$el.addClass("loading");this.__scroller=this.__scroller||this.$el;this.collection.enumerated().then(function(){this.isDeleted()||(this.renderTemplate(),$(this.__scroller).on("scroll."+this.__namespace,this.__onScroll.bind(this)),this.$el.removeClass("loading"),this.collection.on("paged",this.__onPaged,this),this.collection.on("syncing",this.__onSync,this))}.bind(this))["catch"](function(){this.$el.removeClass("loading");
this.onInitError()}.bind(this))},__onSync:function(b){!1===b&&this.__ensureContainerFilled()},onInitError:function(){},renderTemplate:function(){throw Error("renderTemplate() should be implemented");},__ensureContainerFilled:function(){this.__maybePage()},__onScroll:function(){this.__maybePage()},__onPaged:function(){this.$el.removeClass("loading");this.__maybePage()},onPageError:function(b){this.$el.removeClass("loading")},__maybePage:function(){this.__shouldPage()&&this.collection.hasNextPage()&&
(this.$el.addClass("loading"),this.__noVisibilityChecks=!0,this.collection.getNextPage().then(function(){this.__noVisibilityChecks=!1;this.__onPaged()}.bind(this))["catch"](this.onPageError.bind(this)))},__childrenInDOM:function(){var b=_.map(_.filter(_.values(this.__registry),function(d){return d.$el}),function(d){return d.$el[0]});return this.$el.children().filter(b)},__readyToPage:function(){if(!this.__noVisibilityChecks)return this.isDeleted()||this.collection.isSyncing()||!this.$el.is(":visible")?
!1:this.__childrenInDOM().length===this.collection.length},__shouldPage:function(){if(!this.__readyToPage())return!1;var b=this.__scroller[0]===this.__window?this.__scroller.scrollTop()+this.__scroller.height():this.__scroller.offset().top+this.__scroller.height();var d=this.$el.children().eq(-this.triggerNextPage);return 0===d.length?!0:d.offset().top<=b},onAdd:function(b,d,c){a.prototype.onAdd.call(this,b,d,c);this.__ensureContainerFilled()},show:function(){a.prototype.show.call(this);this.__ensureContainerFilled()},
onReset:function(b,d){this.collection.enumerated().then(function(){a.prototype.onReset.call(this,b,d);this.__ensureContainerFilled()}.bind(this))},onSort:function(b,d){this.collection.enumerated().then(function(){a.prototype.onSort.call(this,b,d)}.bind(this))}})}({ListPresenter:J}),F=function(h){return h.UiContext.extend("EdgeRefPresenter",{edgePresenterFactory:void 0,nodePresenterFactory:void 0,initialize:function(a){h.UiContext.prototype.initialize.call(this,a);this.addToDOM();this.edgePresenterFactory&&
(this.edgePresenter=this.createChildContext(this.edgePresenterFactory,{model:this.model.edge,$parentElement:this.$el}));this.nodePresenterFactory&&(this.nodePresenter=this.createChildContext(this.nodePresenterFactory,{model:this.model.node,$parentElement:this.$el}))},delete:function(){if(this.edgePresenter)this.edgePresenter["delete"]();if(this.nodePresenter)this.nodePresenter["delete"]();h.UiContext.prototype["delete"].apply(this,arguments)}})}({UiContext:w}),K=function(h){return IMVU.BaseClass.extend("GlobalErrorHandler",
{dependencies:["root","window"],initialize:function(a){this.serviceProvider=a.serviceProvider;this.root=a.root;a.window.onerror=this.onerror.bind(this)},onerror:function(a,b,d){this.serviceProvider.create(h.RestModel,{id:this.root+"/error_report/",message:a,url:b,line:d},{}).save();return!1}})}({RestModel:u}),G=function(h){var a=IMVU.NamedCollection.prototype;return IMVU.NamedCollection.extend("RestCollection",_.extend({dependencies:["modelCache","Promise","rest"],initialize:function(b,d){a.initialize.apply(this,
arguments);if(!d.id)throw Error("RestCollection must have 'id' option.");this.url=d.id;this.rest=IMVU.requireProperty(d,"rest");this.Promise=d.Promise;this.modelCache=IMVU.requireProperty(d,"modelCache");this.appendToSearchCollection=d.appendToSearchCollection;this._initSyncing()},model:h.RestModel,relations:{},_prepareModel:function(b,d){if(!(b instanceof this.model))if("string"===typeof b)b=this.modelCache.get(b,this.model);else throw Error("Must pass in a url or a model of type "+this.model.name);
return a._prepareModel.call(this,b,d)},collectionName:void 0,parse:function(b,d){return null===this.collectionName?b.data:b.data[this.collectionName]},add:function(b,d){d=d||{};_(d).extend({rest:this.rest,parse:!1,modelCache:this.modelCache});return a.add.call(this,b,d)},reset:function(b,d){d=d||{};_(d).extend({rest:this.rest,parse:!1,id:this.url,modelCache:this.modelCache});return!1===d.reset?this.add(b,d):a.reset.call(this,b,d)},hasNextPage:function(){return!!this.relations.next},getNextPage:function(b){if(!this.isSyncing()&&
this.hasNextPage()){var d={url:this.relations.next,reset:!1};b&&_.extend(d,b);return this.fetch({url:d.url,reset:d.reset,success:function(){this.trigger("paged")}.bind(this)})}},hasPreviousPage:function(){return!!this.relations.previous},getPreviousPage:function(b){if(!this.isSyncing()&&this.hasPreviousPage()){var d={url:this.relations.previous,reset:!1};b&&_.extend(d,b);return this.fetch({url:d.url,reset:d.reset,success:function(){this.trigger("paged")}.bind(this)})}},fetch:function(b){this._clearState();
return a.fetch.apply(this,arguments)},forceFetchRefresh:function(){this.rest.invalidate(this.url);this.fetch()},invalidate:function(){var b=[];this.each(function(d){this.rest.invalidate(d.id);b.push(d.id)}.bind(this));this.modelCache.invalidate(this.url);this.enumerated().then(function(){this.each(function(d){-1!==b.indexOf(d.id)&&d.fetch()})}.bind(this))},release:function(){this.each(function(b){b.release()}.bind(this));this.rest.invalidate(this.url);this.modelCache.release(this)},sync:function(b,
d,c){var e=this.url;c&&c.url&&(e=c.url);if("read"!==b)throw Error("Sync with bad method: "+b);if(!e||"string"!==typeof e)throw Error("URL must be specified as a string in RestCollection. Got: "+JSON.stringify(this.url));this._onRequestSent();return h.RestUtil.makeRequest(this.rest,"get",e,void 0,c,function(g,f,k,r){void 0===g?(null===f&&(f={data:{},relations:{}}),d.relations=f.relations,"updates"in f&&(d.updates=f.updates),"total_count"in f.data&&(k=d.total_count,d.total_count=f.data.total_count,
k!==d.total_count&&d.trigger("update",d)),c.success(d,f.data.items,c)):c.error&&c.error(d,k,c);d._onResponseReceived(void 0===g,g)})},populated:function(){return this.enumerated().then(function(){var b=this.map(function(d){return d.node&&this.rest.__404Cache[d.node.id]?this.Promise.resolve():d.populated()}.bind(this));return this.Promise.every(b)}.bind(this)).then(function(){return this}.bind(this))},enumerated:function(){return new this.Promise(function(b){if(this.isError())b.reject();else{var d=
function(c,e){this.off("error",d);b.reject({isError:c,contents:e})}.bind(this);this.on("error",d);this.whenPopulated(function(){this.off("error",d);b.accept(this)}.bind(this))}}.bind(this))}},h.RestSyncingMixin))}({RestModel:u,RestSyncingMixin:y,RestUtil:m}),V=function(h){var a=h.RestModel.extend("NodeModel",{dependencies:["Promise","restModelFactory"],collectionFactories:{},initialize:function(f,k){h.RestModel.prototype.initialize.call(this,f,k);this.restModelFactory=IMVU.requireProperty(k,"restModelFactory");
this.Promise=k.Promise},getEdgeCollection:function(f,k,r){return this.searchEdgeCollection(f,void 0,k,r)},searchEdgeCollection:function(f,k,r,t){if(!this.relations[f])throw Error("'"+f+"' relation not defined on NodeModel: "+IMVU.repr(this.relations));r=r||this.collectionFactories[f]||c;return this.restModelFactory.searchCollection(this.relations[f],k,r,t)},getSummaryCollection:function(f,k){return this.searchEdgeCollection(f,{limit:0},k)},getSingleEdge:function(f,k){if(!this.relations[f])throw Error("'"+
f+"' relation not defined on NodeModel With relations: "+IMVU.repr(this.relations));k=k||a;return this.restModelFactory.readModel(this.relations[f],k)}}),b=h.RestModel.extend("EdgeModel",{dependencies:["restModelFactory"],initialize:function(f,k){h.RestModel.prototype.initialize.call(this,f,k);this.restModelFactory=IMVU.requireProperty(k,"restModelFactory")},deref:function(f){f=f||a;return this.restModelFactory.readModel(this.relations.ref,f)},getType:function(){var f=decodeURIComponent(this.url()).split("/");
return f[f.length-1].split("-")[0]}}),d=h.RestModel.extend("EdgeDerefModel",{edgeFactory:b,nodeFactory:a,dependencies:["Promise","restModelFactory"],initialize:function(f,k){h.RestModel.prototype.initialize.call(this,f,k);this.restModelFactory=k.restModelFactory;this.Promise=k.Promise;this.id=f.id;this.edge=this.restModelFactory.readModel(k.edgeUrl,this.edgeFactory,{nofetch:!0});this.edge.on("all",function(r){var t=_.toArray(arguments);t[1]=this;this.trigger.apply(this,t);t[0]="edge:"+t[0];this.trigger.apply(this,
t)},this);this.edge.populated().then(function(){this.node=this.edge.deref(this.nodeFactory);this.node.on("all",function(r){var t=_.toArray(arguments);t[1]=this;this.trigger.apply(this,t);t[0]="node:"+t[0];this.trigger.apply(this,t)},this)}.bind(this))},invalidate:function(){this.edge.invalidate()},fetch:function(){this.edge.fetch()},populated:function(){return this.edge.populated().then(function(){return this.node.populated()}.bind(this))},isPopulated:function(){return this.edge.isPopulated()&&this.node&&
this.node.isPopulated()},isError:function(){return this.edge.isError()||this.node&&this.node.isError()},isSyncing:function(){return this.edge.isSyncing()||this.node&&this.node.isSyncing()},toJSON:function(){return{edge:this.edge.toJSON(),node:this.node.toJSON()}}}),c=h.RestCollection.extend("EdgeCollection",{model:d,dependencies:["modelCache","Promise","rest"],initialize:function(f,k){this.serviceProvider=k.serviceProvider;this.Promise=k.Promise;this.rest=k.rest;this.modelCache=k.modelCache;h.RestCollection.prototype.initialize.apply(this,
arguments)},_prepareModel:function(f,k){var r=f instanceof this.model?f:null;r||(r=this.modelCache.get("deref:"+f,this.model,{},{edgeUrl:f}));return h.RestCollection.prototype._prepareModel.call(this,r,k)},create:function(f){return this.rest.post(this.url,f).then(function(k){return 201===k.xhr.status?(k=k.xhr.getResponseHeader("Location"),this.get(k)||this.add(k),this.Promise.resolve(this.get(k))):200===k.xhr.status?this.Promise.resolve(k.response.data):this.Promise.reject()}.bind(this))},remove:function(f){var k=
/^deref:/;"string"!==typeof f||k.exec(f)||(f="deref:"+f);return h.RestCollection.prototype.remove.call(this,f)},get:function(f){var k=/^deref:/;"string"!==typeof f||k.exec(f)||(f="deref:"+f);return h.RestCollection.prototype.get.call(this,f)},getMyEdge:function(){return this.relations.my_edge?this._prepareModel(this.relations.my_edge):null},invalidate:function(){var f=[];this.each(function(k){this.rest.invalidate(k.edge.id);f.push(k.id)}.bind(this));this.modelCache.invalidate(this.url);this.enumerated().then(function(){this.each(function(k){-1!==
f.indexOf(k.id)&&k.fetch()})}.bind(this))},release:function(){this.each(function(f){f.edge.release()}.bind(this));this.rest.invalidate(this.url);this.modelCache.release(this)}}),e=h.RestCollection.extend("NodeCollection",{model:a}),g=IMVU.BaseClass.extend("GraphRoot",{modelFactory:a,dependencies:["Promise","restModelFactory","root"],initialize:function(f){this.restModelFactory=f.restModelFactory;this.root=f.root;this.Promise=f.Promise;this.__url=this.root+this.endpoint},create:function(f){return this.restModelFactory.createModel(this.__url,
this.modelFactory,f)},search:function(f,k){k=k||e;return this.restModelFactory.searchCollection(this.__url,f,k)}});return{NodeModel:a,EdgeModel:b,EdgeDerefModel:d,EdgeCollection:c,NodeCollection:e,GraphRoot:g}}({RestCollection:G,RestModel:u}),W=function(h){return IMVU.BaseClass.extend("IndexedDBManager",{dependencies:["Promise","window"],__DB_NAME:"cache",__DB_VERSION:1,initialize:function(a){this.__Promise=a.Promise;this.__window=a.window;this.__tableKey=this.__tableName=null;this.__tableIndices=
[];this._fakeIndexedDB=a.fakeIndexedDB||!1;this._fakeData=a.fakeData||[];if(this.__window.indexedDB)this.onInitialize(a);else this.__window.console.log("IndexedDB - Not supported by this browser");this.__appMonitorQueue=null;this.__findAppMonitorQueue()},__findAppMonitorQueue:function(){if(!this.__appMonitorQueue){var a=null;try{a=this.__serviceProvider.get("appMonitorQueue")}catch(b){return!1}return a?(this.__appMonitorQueue=a,!0):!1}return!0},onInitialize:function(a){this.__useTable(a.tableName,
a.tableSchema)},__useTable:function(a,b){if(!a)throw Error("IndexedDB - table name is not set");if(!b)throw Error("IndexedDB - table schema is not set");this.__tableName=a;this.__assertDefinition(b);this.__openRequestPromise=new this.__Promise(function(d){this.__openRequestResolver=d}.bind(this));this.__createDB().then(this.__connectDB.bind(this))},__assertDefinition:function(a){if(!Array.isArray(a))throw Error("IndexedDB - table schema should be a object array");a.forEach(function(b){if(b.is_key){if(this.__tableKey)throw Error('IndexedDB - keyPath is already defined as "'+
this.__tableKey+'", but trying to redefine it to "'+b.name+'"');this.__tableKey=b.name}b.index&&this.__tableIndices.push({name:b.name,unique:!!b.unique})}.bind(this));if(!this.__tableKey)throw Error("IndexedDB - key is not set");},__assertKey:function(a){if(!a)throw Error('"key" is required');return!0},__assertData:function(a){if(!a)throw Error('"data" is required');if(!a.hasOwnProperty(this.__tableKey))throw Error('"data" must contains keyPath "'+this.__tableKey+'"');return!0},__createDB:function(){this.__createRequestPromise=
new this.__Promise(function(b){this.__createRequestResolver=b}.bind(this));if(this._fakeIndexedDB)return this.__createRequestResolver.resolve(),this.__createRequestPromise;var a=this.__window.indexedDB.open(this.__DB_NAME,this.__DB_VERSION);a.onupgradeneeded=function(b){b=b.target.result;if(!b.objectStoreNames.contains(this.__tableName)){var d=b.createObjectStore(this.__tableName,{keyPath:this.__tableKey});(b=this.__tableIndices)&&0<b.length&&b.forEach(function(c){d.createIndex(c.name,c.name,{unique:c.unique})})}this.__createRequestResolver.resolve();
this.__window.console.log("IndexedDB - Database create success")}.bind(this);a.onsuccess=function(b){this.__createRequestResolver.resolve()}.bind(this);a.onerror=function(b){this.__window.console.log("IndexedDB - Database create failure: "+b.target.error.message);this.__createRequestResolver.reject("IndexedDB - Database create failure: "+b.target.error.message)}.bind(this);return this.__createRequestPromise},__connectDB:function(){if(this._fakeIndexedDB)this.__openRequestResolver.resolve();else{var a=
this.__window.indexedDB.open(this.__DB_NAME,this.__DB_VERSION);a.onsuccess=function(b){this.__openRequestResolver.resolve(b.target.result);this.__window.console.log("IndexedDB - Database open success")}.bind(this);a.onerror=function(b){this.__window.console.log("IndexedDB - Database open failure: "+b.target.error.message);this.__openRequestResolver.reject("IndexedDB - Database open failure: "+b.target.error.message)}.bind(this)}},connected:function(){return this.__openRequestPromise},__getObjectStore:function(a,
b){return b?a.transaction(this.__tableName,b).objectStore(this.__tableName):a.transaction(this.__tableName).objectStore(this.__tableName)},get:function(a){if(this.__assertKey(a)){var b,d=new this.__Promise(function(c){b=c}.bind(this));if(this._fakeIndexedDB)return b.resolve(this._fakeData[a]),d;this.connected().then(function(c){c=this.__getObjectStore(c).get(a);c.onsuccess=function(e){b.resolve(e.target.result)};c.onerror=function(e){b.reject("IndexedDB - Database get failure: "+e.target.error.message)}}.bind(this))["catch"](function(c){b.reject(c)}.bind(this));
return d}},getAll:function(){var a,b=new this.__Promise(function(d){a=d}.bind(this));if(this._fakeIndexedDB)return a.resolve(this._fakeData),b;this.connected().then(function(d){d=this.__getObjectStore(d).getAll();d.onsuccess=function(c){a.resolve(c.target.result)};d.onerror=function(c){a.reject("IndexedDB - Database getAll failure: "+c.target.error.message)}}.bind(this))["catch"](function(d){a.reject(d)}.bind(this));return b},add:function(a){this.__assertData(a);var b,d=new this.__Promise(function(c){b=
c}.bind(this));if(this._fakeIndexedDB)return this._fakeData[a[this.__tableKey]]=a,b.resolve(a),d;this.connected().then(function(c){c=this.__getObjectStore(c,"readwrite");try{var e=c.put(a)}catch(f){b.reject("IndexedDB - 1 - Data add failure: "+f.message);if(this.__findAppMonitorQueue()){e=f.message?f.message:"UICore::IndexedDBManager::add - Failed to add data to the objectStore";c=[];if(f.stack){var g=null!==f?f.stack.split("\n").map(function(k){return k.trim()}):[];c.push("UICORE ERROR STACK...");
c=c.concat(g)}c.push("STRINGIFIED data...");c.push(JSON.stringify(a));this.__appMonitorQueue.push("IndexedDBManager","add","UICore_error_001",e,c)}return}e.onsuccess=function(){b.resolve("IndexedDB - Data add success")};e.onerror=function(f){b.reject("IndexedDB - 2 - Data add failure: "+f.target.error.message)}}.bind(this))["catch"](function(c){b.reject(c.message)}.bind(this));return d},remove:function(a){if(this.__assertKey(a)){var b,d=new this.__Promise(function(c){b=c}.bind(this));if(this._fakeIndexedDB)return delete this._fakeData[a],
b.resolve(),d;this.connected().then(function(c){c=this.__getObjectStore(c,"readwrite")["delete"](a);c.onsuccess=function(e){b.resolve("IndexedDB - Data remove success")};c.onerror=function(e){b.reject("IndexedDB - Data remove failure: "+e.target.error.message)}}.bind(this))["catch"](function(c){b.reject(c)}.bind(this));return d}},clear:function(){var a,b=new this.__Promise(function(d){a=d}.bind(this));if(this._fakeIndexedDB)return this._fakeData=[],a.resolve(),b;this.connected().then(function(d){d=
this.__getObjectStore(d,"readwrite").clear();d.onsuccess=function(c){a.resolve("IndexedDB - Object store clear success")};d.onerror=function(c){a.reject("IndexedDB - Object store clear failure: "+c.target.error.message)}}.bind(this))["catch"](function(d){a.reject(d)}.bind(this));return b},_setFakeData:function(a){this._fakeData=a}})}({}),O=function(h){return IMVU.BaseClass.extend("loginManager",{dependencies:["eventBus","rest","root","serviceProvider"],initialize:function(a){this.serviceProvider=
a.serviceProvider;this.eventBus=a.eventBus;this.rest=a.rest;this.root=a.root;this.checking=!1;var b=this.root+"/login/me";this.eventBus.on("restError",function(d,c,e){this.checking||e===b||(this.checking=!0,403===c.status&&(this.rest.invalidate(b),this.rest.get(b).then(function(g){this.checking=!1}.bind(this),function(g){this.eventBus.trigger("logout");this.checking=!1}.bind(this))))},this)}})}({}),P=function(h){return IMVU.BaseClass.extend("ModelCache",{dependencies:["rest","timer","window"],initialize:function(a){this.serviceProvider=
a.serviceProvider;this.rest=a.rest;this.__timer=a.timer;this.__window=a.window;this.__instances={};this.__collections={};this.__active={};this.__invalidationPolicy={};this.setInvalidationPolicy(a.invalidationPolicyKey)},get:function(a,b,d,c,e){c=c||{};if(d&&"id"in d&&d.id!==a)throw Error("Cannot update id of a model "+JSON.stringify([a,d.id]));if(a in this.__collections)throw Error("The same URL cannot be both an instance and a collection: "+a);a in this.__instances?_.isEmpty(d)||this.__instances[a]!==
d&&this.__instances[a].set(d):(d=d||{},c=c||{},d=_.extend({id:a},d),b=this.serviceProvider.create(b,d,c),this.__instances[a]=b,b instanceof h.RestModel&&!0!==c.nofetch&&b.fetch(e));return this.__instances[a]},multiGetSetParams:function(a){this.__multiGetBatchSize="undefined"!==typeof a.multiGetBatchSize?Number(a.multiGetBatchSize):Number(this.__multiGetBatchSize);this.__multiFetchUrl="undefined"!==typeof a.multiFetchUrl?String(a.multiFetchUrl):String(this.__multiFetchUrl);this.__multiFetchBatchSize=
"undefined"!==typeof a.multiFetchBatchSize?Number(a.multiFetchBatchSize):Number(this.__multiFetchBatchSize)},getMulti:function(a,b,d,c){if(null===a||"undefined"===typeof a||a.startsWith("undefined"))return!1;d=d||[];if(0===d.length)return!0;d=_.uniq(d);c="undefined"!==typeof c?c:{};for(var e=[],g=0,f=d.length,k=0,r,t;k<f;k++)"undefined"===typeof e[g]&&(e[g]=[]),r=d[k],0!==this.__instances.length&&_.has(this.__instances,r)||(t=this.serviceProvider.create(b,{id:r},c),this.__instances[r]=t,e[g].push(r)),
e[g].length===this.__multiGetBatchSize&&g++;if(0===e.length||0===e[0].length)return!0;if("undefined"===typeof this.__multiGetBatchSize)throw Error("The multiGet parameters for the batch size has not been set, check your implementation");b=[];for(g=0;g<e.length;g++)0<e[g].length&&(d={id:e[g].join(",")},d=a+"?"+$.param(d),this.rest.invalidate(d),d=this.rest.get(d),this.__reviewMultiGetResponse(d),b.push(d));return 0===b.length?!0:b},__reviewMultiGetResponse:function(a){a.then(function(b){b="undefined"!==
typeof b&&"undefined"!==typeof b.xhr&&"undefined"!==typeof b.xhr.responseText?b.xhr.responseText:"";if(""!==b){var d=null;try{d=JSON.parse(b)}catch(e){window.console.warn("ModelCache::__parseMultiGetResponse - Failed to convert xhrResponseText to JSON object",b);return}if("undefined"!==typeof d.http){var c=d.http;Object.keys(c).forEach(function(e){404===c[e].status&&this.invalidate(e)}.bind(this))}}}.bind(this))},setInvalidationPolicy:function(a){this.__invalidationPolicyKey="undefined"===typeof a?
"default":a;switch(this.__invalidationPolicyKey){case "instant":case "default":this.__invalidationPolicy={realtime:!0};break;case "with_hinting":this.__invalidationPolicy={realtime:!1};break;default:return window.console.warn('ModelCache got bad invalidation policy, "'+this.__invalidationPolicyKey+'", falling back to default.'),this.setInvalidationPolicy("default")}},getCollection:function(a,b,d,c){d=d||{};if(a in this.__instances)throw Error("The same URL cannot be both an instance and a collection: "+
a);if(!(a in this.__collections)){d=_.extend({id:a},d);if(d.id!==a)throw Error("Inconsistent id/URL in ModelCache.getCollection(): id="+d.id+", url="+a);b=this.serviceProvider.create(b,[],d);this.__collections[a]=b;b instanceof h.RestCollection&&!0!==d.nofetch&&b.fetch(c)}return this.__collections[a]},release:function(a){a=_.result(a,"url");if(!this.__active[a])if(a in this.__instances){if(this.__invalidator&&this.__instances[a].updates){var b=this.__instances[a].updates;this.__invalidator.unwatch(b.queue,
b.mount,a)}delete this.__instances[a]}else if(a in this.__collections)this.__invalidator&&this.__collections[a].updates&&(b=this.__collections[a].updates,this.__invalidator.unwatch(b.queue,b.mount,a)),delete this.__collections[a];else throw"Unexpected: ModelCache has no model "+a;},_inCache:function(a){return a in this.__instances||a in this.__collections},invalidate:function(a,b){b&&!1===b.invalidateRest||this.rest.invalidate(a);var d=this.__instances[a]||this.__collections[a];b&&!1===b.reset||void 0===
d||(d.fetch(b),"undefined"!==typeof d&&"undefined"!==typeof d.dirty&&delete d.dirty,this.__active[a]&&(this.__active[a].lastFetch=this.__timer.getTime()))},queueInvalidate:function(a,b){if(this.__invalidationPolicy.realtime)return this.invalidate(a);var d=this.__instances[a]||this.__collections[a];if(void 0!==d)if(this.__active[a]){var c=this.__timer.getTime(),e=1E3*this.getResolution(a);e=this.__active[a].lastFetch+e;var g=[];_.each(this.__active[a].refs,function(k,r){g=_.union(g,k.hints)});var f=
!1;_.each(b,function(k,r){_.contains(g,r)&&(d.set(r,k),f=!0)});f||(c>=e?this.invalidate(a):void 0===this.__active[a].fetchTimeout&&(this.__active[a].fetchTimeout=this.__timer.setTimeout(function(){this.invalidate(a)}.bind(this),e-c)))}else d.dirty=!0},authoritativeSetModel:function(a,b){if(!a)throw Error("Must have a url to authoritatively set model: "+IMVU.repr(b));void 0!==this.__instances[a]?this.__instances[a].set(b.attributes):this.__instances[a]=b},setInvalidator:function(a){this.__invalidator=
a},activate:function(a,b,d,c){var e=c||0;void 0===b&&(b=a,a=void 0,e=0);c=_.result(b,"url");this.__active[c]||(this.__active[c]={model:b,resolution:0,lastFetch:this.__timer.getTime(),simplerefs:0,refs:[]});void 0===a?this.__active[c].simplerefs++:this.__active[c].refs.push({context:a,hints:d||[],resolution:e});this.__recalculateResolutionInterval(c);d=this.__instances[c]||this.__collections[c];"undefined"!==typeof d&&"undefined"!==typeof d.dirty&&d.dirty&&this.invalidate(c)},deactivate:function(a,
b){var d=a;a=b;void 0===a&&(a=d,d=void 0);a=_.result(a,"url");this.__active[a]&&(b=_.findIndex(this.__active[a].refs,function(c){return c.context===d}),0>b?this.__active[a].simplerefs--:this.__active[a].refs.splice(b,1),0>=this.__active[a].simplerefs+this.__active[a].refs.length?(this.__active[a].fetchTimeout&&this.__timer.clearTimeout(this.__active[a].fetchTimeout),delete this.__active[a]):this.__recalculateResolutionInterval(a))},__recalculateResolutionInterval:function(a){if(this.__active[a])if(0<
this.__active[a].simplerefs)this.__active[a].resolution=0;else{var b=this.__active[a].resolution;this.__active[a].resolution=_.reduce(this.__active[a].refs,function(d,c){return Math.min(c.resolution||0,d)},this.__active[a].refs[0].resolution||0);void 0!==this.__active[a].fetchTimeout&&this.__active[a].resolution<b&&(this.__timer.clearTimeout(this.__active[a].fetchTimeout),this.queueInvalidate(a))}},getActive:function(){return _.map(this.__active,function(a){return a.model})},getResolution:function(a){return this.__active[a]?
this.__active[a].resolution:null},refreshActive:function(){_.each(this.__collections,function(a){a.dirty=!0});_.each(this.__instances,function(a){a.dirty=!0});_.each(this.__active,function(a){a=_.result(a.model,"url");this.invalidate(a)}.bind(this))},exportModels:function(){return this.__instances},importModel:function(a,b){a in this.__instances||(this.__instances[a]=b)}})}({RestCollection:G,RestModel:u}),X=function(h){return IMVU.BaseClass.extend("ModelInvalidator",_.extend({dependencies:["imqManager",
"modelCache","rest"],initialize:function(a){this.__imqManager=IMVU.requireProperty(a,"imqManager");this.rest=IMVU.requireProperty(a,"rest");this.__modelCache=IMVU.requireProperty(a,"modelCache");this.subscriptions={};this.needNotification=[];this.requestingNotification=!1;this.rest.setInvalidator(this);this.__modelCache.setInvalidator(this);this.__imqManager.connect().then(function(){this.__imqManager.state.on("change:status",function(){"connected"===this.__imqManager.state.get("status")&&this.__modelCache.refreshActive()}.bind(this))}.bind(this));
this.__imqManager.subscribeMessage("/user/"+this.__imqManager.config.userId,"web_msg",function(b,d){this.listenTo(d,"message",function(c){if("private_invalidation"===c.message.substr(0,20)){try{var e=JSON.parse(c.message.substring(21))}catch(g){return}switch(e.action){case "updated":_.each(e.invalidate,function(g){this.__modelCache.queueInvalidate(g)}.bind(this))}}}.bind(this))}.bind(this))},watch:function(a,b,d){_.isUndefined(this.subscriptions[a])&&(this.subscriptions[a]={});this.__addSubscription(a,
b,d);_.isUndefined(this.subscriptions[a][b].mount)&&this.__imqManager.subscribeMessage(a,b,this.__onSubscribe.bind(this,a,b,d))},unwatch:function(a,b,d){a in this.subscriptions&&b in this.subscriptions[a]&&(this.subscriptions[a][b].ids=d?_.without(this.subscriptions[a][b].ids,d):[],_.isEmpty(this.subscriptions[a][b].ids)&&(this.subscriptions[a][b].mount&&this.subscriptions[a][b].mount.off(),delete this.subscriptions[a][b]))},unwatchAll:function(){_.each(this.subscriptions,function(a,b){_.each(a,function(d,
c){this.unwatch(b,c)}.bind(this))}.bind(this))},__addSubscription:function(a,b,d,c){"node"===b?_.isUndefined(this.subscriptions[a][b])?this.subscriptions[a][b]={id:d}:this.subscriptions[a][b].id=d:_.isUndefined(this.subscriptions[a][b])?this.subscriptions[a][b]={ids:[d]}:(this.subscriptions[a][b].ids.push(d),this.subscriptions[a][b].ids=_.uniq(this.subscriptions[a][b].ids))},__onSubscribe:function(a,b,d,c,e){!c&&this.subscriptions[a][b]&&(e.on("message",this.__handleMessage.bind(this,a,b)),this.subscriptions[a][b].mount=
e)},__handleMessage:function(a,b,d){var c=JSON.parse(d.message);d=c.updates||{};if("node"===b)a=this.subscriptions[a][b].id,b={},d[a]&&(b=d[a].data),this.__modelCache.queueInvalidate(a,b);else switch(c.action){case "created":_.each(this.subscriptions[a][b].ids,function(e){var g=this.__modelCache._inCache(e)?this.__modelCache.getCollection(e):null;-1===e.indexOf("?")||/\?summary=1$/.exec(e)||/\?limit=0$/.exec(e)?(this.rest.invalidate(e),g&&_.each(c.objects,function(f){g.total_count++;/\?summary=1$/.exec(e)||
/\?limit=0$/.exec(e)?g.trigger("update",g):g.add(f)}.bind(this))):g&&g.appendToSearchCollection?(this.rest.invalidate(e),_.each(c.objects,function(f){g.total_count++;g.add(f)}.bind(this))):this.__modelCache.queueInvalidate(e)}.bind(this));break;case "updated":_.each(c.objects,function(e){this.__modelCache.queueInvalidate(e)}.bind(this));break;case "deleted":_.each(this.subscriptions[a][b].ids,function(e){-1===e.indexOf("?")?(this.rest.invalidate(e),_.each(c.objects,function(g){if(this.__modelCache._inCache(e)){var f=
this.__modelCache.getCollection(e),k=f.get(g);k&&f.total_count--;f.remove(g);this.rest.invalidate(g);k&&this.__modelCache.release(k)}}.bind(this))):this.__modelCache.queueInvalidate(e)}.bind(this));break;default:throw Error("Unrecognized message action: "+c.action);}},refreshAll:function(){this.rest.invalidateAll();_.each(this.subscriptions,function(a){_.each(a,function(b,d){"node"!==d&&_.each(b.ids,function(c){this.__modelCache.invalidate(c,{invalidateRest:!1})}.bind(this))}.bind(this))}.bind(this));
_.each(this.subscriptions,function(a){_.each(a,function(b,d){"node"===d&&this.__modelCache.invalidate(b.id,{invalidateRest:!1})}.bind(this))}.bind(this))}},Backbone.Events))}({}),Q=function(h){return Backbone.Collection.extend({constructor:function(a,b){function d(){this.reset(_.map(this.collection.models,c))}Backbone.Collection.prototype.constructor.call(this);this.collection=IMVU.requireProperty(b,"collection");var c=IMVU.requireProperty(b,"wrap");this.collection.on("reset",d,this);this.collection.on("add",
function(e){this.add(c(e))},this);this.collection.on("remove",function(e,g,f){this.remove(this.at(f.index))},this);d.call(this);return this}})}({}),Y=function(h){var a={"data-reactive-syncing":function(b,d,c){var e=$(d);b.on("syncing",function(g){e.toggleClass(c,g)});e.toggleClass(c,b.isSyncing())},"data-reactive-error":function(b,d,c){var e=$(d);b.on("error",function(g,f){e.toggleClass(c,g);e.children(".error-message").text(g?f.message:"");e.children(".error-code").text(g?f.error:"")});b.isError()&&
(e.toggleClass(c,!0),b=b.getError(),e.children(".error-message").text(b.message),e.children(".error-code").text(b.error))},"data-reactive-contents":function(b,d,c){var e=$(d);b.on("change:"+c,function(){e.text(b.get(c))});b.has(c)&&e.text(b.get(c))},"data-reactive-attrs":function(b,d,c){var e=$(d);d=JSON.parse(c);_(d).each(function(g,f){b.on("change:"+g,function(){e.attr(f,b.get(g))});b.has(g)&&e.attr(f,b.get(g))})}};return h.UiContext.extend("ReactivePresenter",{render:function(b,d){var c=document.createElement("div");
c.innerHTML=b;_(a).each(function(e,g){_(c.querySelectorAll("["+g+"]")).each(function(f){var k=f.getAttribute(g);a[g](d,f,k)})});$(c).children().remove().appendTo(this.el)}})}({UiContext:w}),T=function(h){return IMVU.BaseClass.extend("Rest",{dependencies:["eventBus","Promise","XMLHttpRequest"],TIMEOUT_MS:3E4,initialize:function(a){this.XMLHttpRequest=IMVU.requireProperty(a,"XMLHttpRequest");this.__requestQueue={};this.__responseCache={};this.__404Cache={};this.__inFlight={};this.__applicationHeader=
this.__invalidator=void 0;this.Promise=a.Promise;this.serviceProvider=a.serviceProvider;this.eventBus=a.eventBus;this.serviceProvider.has("emulateNetworkError")&&(this.__emulateNetworkError=this.serviceProvider.get("emulateNetworkError"))},getErrorEmulation:function(){if(this.__emulateNetworkError)return _.map(this.__emulateNetworkError,function(a){var b=_.clone(a);a.queryMatch&&(b.queryMatch=_.clone(a.queryMatch));return b}.bind(this))},setErrorEmulation:function(a){this.__emulateNetworkError=a},
clearErrorEmulation:function(){delete this.__emulateNetworkError},setInvalidator:function(a){this.__invalidator=a;_(this.__responseCache).each(function(b,d){this.__listenForInvalidation(d)}.bind(this))},invalidate:function(a){this.__inFlight[a]&&"GET"===this.__inFlight[a].method&&this.__restartInFlight(a,void 0,void 0);delete this.__responseCache[a]},invalidateAll:function(){this.__responseCache={}},precache:function(a){_.each(a,function(b,d){this.__updateCache(d,b,{status:200})}.bind(this))},__listenForInvalidation:function(a){if(this.__invalidator){var b=
this.__responseCache[a].response.updates;b&&b.queue&&b.mount&&this.__invalidator.watch(b.queue,b.mount,a)}},cancelAll:function(a){var b=this.ERROR_ABORT;this.__inFlight[a]&&this.__cancelInFlight(a,void 0,b);this.__requestQueue[a]&&(_.each(this.__requestQueue[a],function(d){var c=new this.XMLHttpRequest;c.abort();d.onComplete(b,void 0,c)}.bind(this)),delete this.__requestQueue[a])},__restartInFlight:function(a,b,d){b=this.__inFlight[a].method;d=this.__inFlight[a].xhr;var c=this.__inFlight[a].body,
e=this.__inFlight[a].options,g=this.__inFlight[a].onComplete;d.onabort=function(){};d.onreadystatechange=function(){};d.abort();this.__makeRequest(b,a,c,e,g)},__cancelInFlight:function(a,b,d){var c=this.__inFlight[a].xhr,e=this.__inFlight[a].onComplete;c.onabort=function(){};c.abort();delete this.__inFlight[a];e(d,b,c)},__request:function(a,b,d,c,e){_.isFunction(c)&&(e=c,c={});var g=this.eventBus;return new this.Promise(function(f){function k(v,B,A,H){var L=r.getErrorEmulation();if(!v&&L){var S=_.findKey(L,
function(I,D){D=new RegExp(I.pathMatch+"(\\?.*)*$");D=H?H.match(D):void 0;if(I.hasOwnProperty("queryMatch"))return D&&D[1]?(D=D[1].replace(/\?/,"").split(/&/),D=_.map(D,function(M){var R=M.indexOf("=");return-1===R?M:M.substr(0,R)}),I=_.intersection(D,I.queryMatch),0!==I.length&&window.console.log("Error simulated because keys matched: ",I),I.length):!1;D&&window.console.log("Error simulated on URL match: ",D);return D});S&&(v=L[S],v={error:v.error,message:v.message},A={status:v.hasOwnProperty("error")?
v.error:500,statusMessage:v.hasOwnProperty("message")?v.message:"Unknown system error"},window.console.log("Simulated error: ",v,A))}H=H||b;e&&e(v,B,A,H);v?(f.reject({error:v,xhr:A,url:H}),g.trigger("restError",v,A,H)):f.resolve({response:B,xhr:A,url:H})}var r=this;if(this.__inCacheAndCacheable(a,b))k(void 0,this.__responseCache[b].response,this.__responseCache[b].xhr,b);else{var t=this;this.__queueRequest(b,a,function(v){t.__inCacheAndCacheable(a,b)?(k(void 0,t.__responseCache[b].response,t.__responseCache[b].xhr,
b),v()):t.__makeRequest(a,b,d,c,function(){delete t.__inFlight[b];k.apply(void 0,arguments);v()})},k)}}.bind(this))},__inCacheAndCacheable:function(a,b){return"GET"===a&&b in this.__responseCache},__makeRequest:function(a,b,d,c,e){function g(v){return function(){e(v,void 0,f)}}var f=new this.XMLHttpRequest;b=b.replace(/\/$/,"");var k=!1;this.__inFlight[b]={method:a,xhr:f,body:d,options:c,onComplete:e};c=c||{};var r=c.dataType||"json",t="json"===r?"application/json; charset=utf-8":"application/xml; charset=utf-8";
f.open(a,b);f.timeout=IMVU.optionalProperty(c,"timeout",this.TIMEOUT_MS);f.withCredentials=!1===c.withCredentials?!1:!0;c&&c.headers&&_.each(c.headers,function(v,B){B&&"ACCEPT"===B.toUpperCase()&&(k=!0);f.setRequestHeader(B,v)});k||f.setRequestHeader("Accept",t);"GET"!==a&&f.setRequestHeader("Content-Type",t);if("POST"===a||"PUT"===a||"DELETE"===a)"xml"===r&&g("Do not spport non-GETs to xml")(),(t=this.serviceProvider.get("sauce"))&&f.setRequestHeader("X-imvu-sauce",t),this.__applicationHeader&&f.setRequestHeader("X-imvu-application",
this.__applicationHeader);f.onabort=g(this.ERROR_ABORT);f.onerror=g(this.ERROR_NETWORK);f.ontimeout=g(this.ERROR_TIMEOUT);c.onProgress&&(f.onprogress=c.onProgress);"POST"!==a&&"PUT"!==a||this.__addUploadEventListeners(f.upload,c);f.onreadystatechange=function(){if(4===f.readyState&&0!==f.status)if(204===f.status)e(void 0,"",f);else{if("json"===r)try{var v=JSON.parse(f.responseText)}catch(A){v=f.responseText}else"xml"===r&&(v=f.responseXML);if(200<=f.status&&400>f.status){this.__updateCache(b,v,f);
v=_.isObject(v)&&"id"in v?v.id:b;var B=void 0!==this.__responseCache[v]?this.__responseCache[v]:{response:null,xhr:f};e(void 0,B.response,B.xhr,v)}else _.isObject(v)?g(v)():g({status:"failure",error:"FAILURE",message:v})()}}.bind(this);f.send(void 0===d?null:JSON.stringify(d))},__addUploadEventListeners:function(a,b){b.onUploadProgress&&(a.onprogress=b.onUploadProgress);b.onUploadStart&&(a.onloadstart=b.onUploadStart);b.onUploadAbort&&(a.onabort=b.onUploadAbort);b.onUploadError&&(a.onerror=b.onUploadError);
b.onUploadSuccess&&(a.onload=b.onUploadSuccess);b.onUploadTimeout&&(a.ontimeout=b.onUploadTimeout)},__updateCache:function(a,b,d){function c(t,v,B,A){t=t.replace(/\/$/,"");e.__responseCache[t]={response:v,xhr:B};e.__listenForInvalidation(t);a!==t&&A!==t&&e.serviceProvider.get("modelCache").invalidate(t,{invalidateRest:!1})}var e=this;if(_.isObject(b)&&"http"in b)for(var g=_.keys(b.http),f=0;f<g.length;f++){var k=g[f];404===b.http[k].status&&(e.__404Cache[k]=!0)}if(_.isObject(b)&&"id"in b&&"denormalized"in
b){var r=b.id.replace(/\/$/,"");_(b.denormalized).each(function(t,v){v=v.replace(/\/$/,"");c(v,t,d,r);a!==v&&r!==v&&e.__inFlight[v]&&"GET"===e.__inFlight[v].method&&e.__cancelInFlight(v,t)})}else c(a,b,d,a)},__queueRequest:function(a,b,d,c){a=a.replace(/\/$/,"");this.__requestQueue[a]=this.__requestQueue[a]||[];this.__requestQueue[a].push({method:b,request:d,onComplete:c});1===this.__requestQueue[a].length&&this.__pumpRequest(a)},__pumpRequest:function(a){a=a.replace(/\/$/,"");0<this.__requestQueue[a].length&&
this.__requestQueue[a][0].request(function(){this.__requestQueue[a].shift();this.__pumpRequest(a)}.bind(this))},setApplicationHeader:function(a){this.__applicationHeader=a},get:function(a,b,d){return this.__request("GET",a,void 0,b,d)},post:function(a,b,d,c){return this.__request("POST",a,b,d,c)},put:function(a,b,d,c){return this.__request("PUT",a,b,d,c)},delete:function(a,b,d){return this.__request("DELETE",a,void 0,b,d)},ERROR_ABORT:{error:"AbortError",message:"Connection aborted"},ERROR_NETWORK:{error:"NetworkError",
message:"Network error"},ERROR_TIMEOUT:{error:"TimeoutError",message:"Network connection timed out"},ERROR_PARSE:{error:"ParseError",message:"Unable to parse response"}})}({}),U=function(h){return IMVU.BaseClass.extend("RestModelFactory",{dependencies:["modelCache","Promise","rest"],initialize:function(a){this.serviceProvider=IMVU.requireProperty(a,"serviceProvider");this.rest=IMVU.requireProperty(a,"rest");this.modelCache=IMVU.requireProperty(a,"modelCache");this.Promise=a.Promise;this.multiGetQueue=
[]},simplePOST:function(a,b){return this.rest.post(a,b).then(function(d){return 200===d.xhr.status?this.Promise.resolve(d.response):this.Promise.reject({code:d.xhr.status,msg:"Invalid response code",response:d.response})}.bind(this))},createModel:function(a,b,d){if(!b)throw Error("ModelType should be defined.");return this.rest.post(a,d).then(function(c){var e=c.xhr.getResponseHeader("Location");return e?this.Promise.resolve(this.readModel(e,b)):this.Promise.reject(c)}.bind(this))},readModel:function(a,
b,d){if(!b)throw Error("ModelType should be defined.");d="undefined"!==typeof d?d:{};d=this.modelCache.get(a,b,{},d);if(Object.getPrototypeOf(d)!==b.prototype)throw Error("Requested ModelType '"+b.name+"' doesn't match previously requested '"+d.constructor.name+"' for url '"+a+"'.");return d},readCollection:function(a,b,d){return this.searchCollection(a,void 0,b,d)},searchCollection:function(a,b,d,c){if(!d)throw Error("CollectionType should be defined.");c="undefined"!==typeof c?c:{};_.isEmpty(b)||
(a+="?"+$.param(b));b=this.modelCache.getCollection(a,d,c);if(!(b instanceof d))throw Error("Requested CollectionType '"+d.name+"' doesn't match previously requested '"+b.constructor.name+"' for url '"+a+"'.");return b},multiGetSetParams:function(a){this.modelCache.multiGetSetParams(a)},multiGetReset:function(a){this.multiGetQueue[a]=[]},__multiGetInitialize:function(a){"undefined"===typeof this.multiGetQueue[a]&&this.multiGetReset(a)},multiGetQueueElement:function(a,b){if(!this.rest.__404Cache[b]){this.__multiGetInitialize(a);
var d=typeof b;"undefined"!==d&&("string"===d?this.multiGetQueue[a].push(b):"object"===d&&(this.multiGetQueue[a]=this.multiGetQueue[a].concat(b)))}},multiGetQueued:function(a){return this.multiGetQueue[a]},multiGetRequest:function(a,b,d){b=this.modelCache.getMulti(a,b,this.multiGetQueue[a],d);!1!==b&&this.multiGetReset(a);return b}})}({RestUtil:m}),Z=function(h){return h.UiContext.extend("RestModelPresenter",{uiContextName:"rest_model_presenter_generic",dependencies:["model"],initialize:function(a){h.UiContext.prototype.initialize.call(this,
a);this.addToDOM();this.model.populated().then(function(){this.model.node.on("change",this.renderTemplate,this)}.bind(this))},render:function(){this.model.populated().then(function(){this.renderTemplate()}.bind(this))},renderTemplate:function(){throw Error("renderTemplate() should be implemented");}})}({UiContext:w}),aa=function(h){return function(a,b,d){var c=h.RestCollection,e=c.extend,g=_,f=g.extend;if(!a)throw new ReferenceError("Must specify ReferenceModelType");return e.call(c,"RestReferenceCollection",
f.call(g,{collectionName:"items",model:a,parent:h.RestCollection,getDereferencedCollection:function(){var k=this.modelCache;return new h.ReactiveCollection([],{collection:this,wrap:function(r){return k.get(r.get("data"),b)}})}},d))}}({ReactiveCollection:Q,RestCollection:G}),N=function(h){return IMVU.ServiceProvider.extend("ServiceProvider",{initialize:function(){IMVU.ServiceProvider.prototype.initialize.call(this);this.register("random",new IMVU.Random);this.register("timer",IMVU.Timer);var a=IMVU.PromiseFactory;
IMVU.NativePromiseFactory&&(window.console.log("NativePromiseFactory",IMVU.NativePromiseFactory),a=IMVU.NativePromiseFactory);this.register("Promise",new a(IMVU.EventLoop,{immediateCallbacks:!0,exposeErrors:!0}));this.register("WrappedPromise",new IMVU.WrappedPromiseFactory);this.register("XMLHttpRequest",IMVU.XMLHttpRequest)}})}({}),ba=function(h){return IMVU.BaseClass.extend("appMonitorQueue",{uiContextName:"app_monitor_queue",className:"app-monitor-queue",initialize:function(a){this.__queue=[];
this.__MAX_QUEUE_SIZE=10;this.__engine=null},setEngine:function(a){for(this.__engine=a;this.__queue.length;)a=this.pop(),this.__engine.reportCustomError(a.fileClass,a.theFunction,a.errorCode,a.errorMessage,a.errorStack)},push:function(a,b,d,c,e){e=e||[];this.__engine?this.__engine.reportCustomError(a,b,d,c,e):(this.__queue.push({fileClass:a,theFunction:b,errorCode:d,errorMessage:c,errorStack:e}),this.__queue.length>this.__MAX_QUEUE_SIZE&&this.pop())},pop:function(){return this.__queue.shift()},_testGetQueue:function(){return this.__queue}})}({});
l=function(h){return h.ServiceProvider.extend("ServiceProvider",{initialize:function(){h.ServiceProvider.prototype.initialize.call(this);this.register("appMonitorQueue",this.create(h.AppMonitorQueue));this.register("window",window);this.register("sauce","");this.register("eventBus",_.clone(Backbone.Events));this.register("imq",h.IMQ);var a=this.get("window").localStorage;void 0!==a.getItem&&(a=a.getItem("emulateNetworkError"))&&this.register("emulateNetworkError",JSON.parse(a));this.register("rest",
this.create(h.Rest));this.register("modelCache",this.create(h.ModelCache));this.register("restModelFactory",this.create(h.RestModelFactory));this.register("defer",_.defer)}})}({IMQ:l["@IMQ"],ServiceProvider:N,AppMonitorQueue:ba,LoginManager:O,ModelCache:P,Rest:T,RestModelFactory:U});N=function(h){var a=h.RestModel.extend("Batch",{add:function(b){var d=this.get("events"),c=d.length?d[d.length-1]:null;b.attributes.repeats&&c&&this.__isRepeat(b,c)?c.attributes.repeats++:d.push(b);this.trigger("change")},
__isRepeat:function(b,d){return b.name===d.name&&b.application===d.application&&b.context===d.context},length:function(){return this.get("events").length}});return IMVU.BaseClass.extend("UiEventReporter",{maxBatchSize:60,maxWaitTime:6E4,dependencies:["Promise","random","root","timer","window"],initialize:function(b){this.serviceProvider=b.serviceProvider;this.timer=b.timer;this.Promise=b.Promise;this.window=b.window;this.random=b.random;this.__serviceUrl=b.root+"/ui_event/";this.__lastEventTime={};
this.__sequenceId=0;b=this.window.localStorage.getItem("UiEventReporter:savedEvents");this.__createBatch(b?JSON.parse(b):null);b&&(this.flush(),this.window.localStorage.removeItem("UiEventReporter:savedEvents"));this.window.onbeforeunload=function(){this.__batch.length()&&(this.__clearTimeout(),this.window.localStorage.setItem("UiEventReporter:savedEvents",JSON.stringify(this.__batch.toJSON())))}.bind(this)},getActivityGroup:function(){var b=this.__getTime();if(!this.__activityGroup||this.__activityGroup.time+
300<b)this.__activityGroup={id:this.random.getString()};this.__activityGroup.time=b;return this.__activityGroup},recordEvent:function(b,d,c,e,g){if(""===c)throw Error("UI event context must be specified");g=g||{};this.getActivityGroup();var f=this.__activityGroup.time;this.__lastEventTime[e]=f;g.activity_group_id=this.__activityGroup.id;this.__sequenceId++;this.__batch.add({name:e,application:b,platform:d,context:c,attributes:g,timestamp:f,sequence_id:this.__sequenceId})},getLastEventTime:function(b){b=
this.__lastEventTime[b];return"undefined"===typeof b?null:b},flush:function(){return this.__sendBatch()},__getTime:function(){return this.timer.getTime()/1E3},__createBatch:function(b){b=b||{events:[]};this.__batch=this.serviceProvider.create(a,b,{});this.__batch.id=this.__serviceUrl;this.__batch.on("change",this.__batchChanged,this)},__clearTimeout:function(){_.isUndefined(this.__sendTimeout)||this.timer.clearTimeout(this.__sendTimeout)},__sendBatch:function(b){return 0===this.__batch.length()?this.Promise.resolve():
new this.Promise(function(d){this.__clearTimeout();var c=this.__batch;this.__createBatch();c.off("change",null,this);c.save({post_time:this.__getTime(),events:c.get("events")},{success:d.accept.bind(d),error:d.reject.bind(d)})}.bind(this))},__batchChanged:function(){this.__batch.length()>=this.maxBatchSize?this.__sendBatch():(this.__clearTimeout(),this.__sendTimeout=this.timer.setTimeout(this.__sendBatch.bind(this),this.maxWaitTime))}})}({RestModel:u});n={AlertDialog:q,CollectionItem:x,ConfirmDialog:z,
DialogManager:C,EdgeCollectionPresenter:E,EdgeRefPresenter:F,GlobalErrorHandler:K,GraphModels:V,IndexedDBManager:W,ListPresenter:J,LoginManager:O,ModalDialog:p,ModelCache:P,ModelInvalidator:X,ReactiveCollection:Q,ReactivePresenter:Y,Rest:T,RestCollection:G,RestModel:u,RestModelFactory:U,RestModelPresenter:Z,RestReferenceCollection:aa,RestSyncingMixin:y,RestUtil:m,ServiceProvider:l,UiContext:w,UiEventReporter:N,UiView:n};"use strict";n.NodeModel=n.GraphModels.NodeModel;n.EdgeModel=n.GraphModels.EdgeModel;
n.EdgeDerefModel=n.GraphModels.EdgeDerefModel;n.EdgeCollection=n.GraphModels.EdgeCollection;n.NodeCollection=n.GraphModels.NodeCollection;n.GraphRoot=n.GraphModels.GraphRoot;return n});
